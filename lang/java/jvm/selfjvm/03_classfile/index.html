<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>03_解析class文件 - 追来者之人</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="追来者之人"><meta name="msapplication-TileImage" content="/img/logo.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="追来者之人"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="解析class文件Java 虚拟机规范中所指的 class 文件，并非特指位于磁盘中的 .class 文件，而是泛指任何格式符合规范的 class 数据。它实际上可以通过网络下载，从数据库加载，甚至是在运行中直接生成等方式来获取 class 文件。  构成 class 文件的基本数据单位是字节，可以把整个 class 文件当成一个字节流来处理 数据由连续多个字节构成，这些数据在 class 文件中"><meta property="og:type" content="blog"><meta property="og:title" content="03_解析class文件"><meta property="og:url" content="http://example.com/lang/java/jvm/selfjvm/03_classfile/"><meta property="og:site_name" content="追来者之人"><meta property="og:description" content="解析class文件Java 虚拟机规范中所指的 class 文件，并非特指位于磁盘中的 .class 文件，而是泛指任何格式符合规范的 class 数据。它实际上可以通过网络下载，从数据库加载，甚至是在运行中直接生成等方式来获取 class 文件。  构成 class 文件的基本数据单位是字节，可以把整个 class 文件当成一个字节流来处理 数据由连续多个字节构成，这些数据在 class 文件中"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/java.png"><meta property="article:published_time" content="2021-10-08T01:10:21.000Z"><meta property="article:modified_time" content="2023-04-02T17:55:24.435Z"><meta property="article:author" content="jiaduo"><meta property="article:tag" content="java"><meta property="article:tag" content="JVM"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/java.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/lang/java/jvm/selfjvm/03_classfile/"},"headline":"03_解析class文件","image":["http://example.com/img/java.png"],"datePublished":"2021-10-08T01:10:21.000Z","dateModified":"2023-04-02T17:55:24.435Z","author":{"@type":"Person","name":"jiaduo"},"publisher":{"@type":"Organization","name":"追来者之人","logo":{"@type":"ImageObject","url":"http://example.com/img/logo.png"}},"description":"解析class文件Java 虚拟机规范中所指的 class 文件，并非特指位于磁盘中的 .class 文件，而是泛指任何格式符合规范的 class 数据。它实际上可以通过网络下载，从数据库加载，甚至是在运行中直接生成等方式来获取 class 文件。  构成 class 文件的基本数据单位是字节，可以把整个 class 文件当成一个字节流来处理 数据由连续多个字节构成，这些数据在 class 文件中"}</script><link rel="canonical" href="http://example.com/lang/java/jvm/selfjvm/03_classfile/"><link rel="icon" href="/img/logo.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="追来者之人" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-3 is-size-4-mobile"><i class="fas fa-blog"> </i>03_解析class文件</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="fas fa-calendar-plus"> </i><time dateTime="2021-10-08T01:10:21.000Z" title="2021-10-08T01:10:21.000Z">2021-10-08</time></span><span class="level-item is-hidden-mobile"><i class="fas fa-calendar-check"> </i><time dateTime="2023-04-02T17:55:24.435Z" title="2023-04-02T17:55:24.435Z">2023-04-03</time></span><span class="level-item"><i class="fas fa-folder"> </i><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a><span> / </span><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/">Java</a></span><span class="level-item"><i class="fas fa-clock"> </i>44 分钟读完 (大约6638个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><div class="content"><h2 id="解析class文件"><a href="#解析class文件" class="headerlink" title="解析class文件"></a>解析class文件</h2><p>Java 虚拟机规范中所指的 class 文件，并非特指位于磁盘中的 .class 文件，而是泛指任何格式符合规范的 class 数据。它实际上可以通过网络下载，从数据库加载，甚至是在运行中直接生成等方式来获取 class 文件。</p>
<ul>
<li>构成 class 文件的基本数据单位是字节，可以把整个 class 文件当成一个字节流来处理</li>
<li>数据由连续多个字节构成，这些数据在 class 文件中以大端（big-endian）方式存储</li>
</ul>
<p>为了描述 class 文件格式，Java 虚拟机规范定义了 u1、u2 和 u4 三种数据类型来表示1、2和4字节无符号整数。</p>
<span id="more"></span>

<ul>
<li>相同类型的多条数据一般按表（table）的形式存储在 class 文件中</li>
<li>表由表头和表项（item）构成，表头是 u2 或 u4 整数</li>
</ul>
<p>整个 class 文件被描述为一个 ClassFile 结构，如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4                 magic;</span><br><span class="line">    u2                 minor_version;</span><br><span class="line">    u2                 major_version;</span><br><span class="line">    u2                 constant_pool_count;</span><br><span class="line">    cp_info            constant_pool[constant_pool_count<span class="number">-1</span>];</span><br><span class="line">    u2                 access_flags;</span><br><span class="line">    u2                 this_class;</span><br><span class="line">    u2                 super_class;</span><br><span class="line">    u2                 interfaces_count;</span><br><span class="line">    u2                 interfaces[interfaces_count];</span><br><span class="line">    u2                 fields_count;</span><br><span class="line">    field_info         fields[fields_count];</span><br><span class="line">    u2                 methods_count;</span><br><span class="line">    method_info        methods[methods_count];</span><br><span class="line">    u2                 attributes_count;</span><br><span class="line">    attribute_info     attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="一、前期准备"><a href="#一、前期准备" class="headerlink" title="一、前期准备"></a>一、前期准备</h2><h3 id="1-1-自定义数据类型"><a href="#1-1-自定义数据类型" class="headerlink" title="1.1 自定义数据类型"></a>1.1 自定义数据类型</h3><p>Java 虚拟机规范定义了 u1、u2 和 u4 三种数据类型来表示1、2和4字节无符号整数。</p>
<p>但是 Java 中都是有符号整数，没有无符号整数，所以这里先定义几种无符号整数类型，实际上它们是由更大范围的整数值来保存的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 8比特无符号整数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Uint8</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Uint8</span><span class="params">(<span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 16比特无符号整数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Uint16</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Uint16</span><span class="params">(<span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 32比特无符号整数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Uint32</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Uint32</span><span class="params">(<span class="type">long</span> val)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用自定义类型的原因是，方便在定义 ClassFile 类时，各个成员变量的类型能更清晰一些，不然都是 int、long 这些类型的话，都不知道 ClassFile 中实际保存的字节数量。</p>
<p>这样增加自定义类型后，下面的 ClassFile 结构就稍微好看一点了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassFile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 魔数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint32 magic;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 次版本号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 minorVersion;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主版本号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 majorVersion;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 常量池常量数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 constantCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 常量池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ConstantPoolInfo constantPool;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类访问标志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 accessFlags;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 className;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 父类名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 superClassName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 interfaceCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16[] interfaces;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 fieldCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> FieldInfo[] fields;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 methodCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> MethodInfo[] methods;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 属性数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 attributesCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 属性定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> AttributeInfo[] attributes;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-类型数据读取"><a href="#1-2-类型数据读取" class="headerlink" title="1.2 类型数据读取"></a>1.2 类型数据读取</h3><p>现在是把 class 文件当成字节流来处理，但是如果直接操作字节是很不方便的。而且前面增加了自定义数据类型，把数据读出来后，还要再转成对应的数据类型，相当麻烦。</p>
<p>所以定义了一个工具类 <code>ClassReader</code> 来帮助读取数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassReader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ByteBuffer buf;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> offset;</span><br><span class="line"></span><br><span class="line">    ClassReader (<span class="type">byte</span>[] bytes) &#123;</span><br><span class="line">        buf = ByteBuffer.wrap(bytes);</span><br><span class="line">        buf.order(ByteOrder.BIG_ENDIAN); <span class="comment">// 大端</span></span><br><span class="line">        offset = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">readInt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.getInt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">readLong</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.getLong();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">readFloat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.getFloat();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">readDouble</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.getDouble();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Uint8 <span class="title function_">readUint8</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> buf.get();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Uint16 <span class="title function_">readUint16</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">short</span> <span class="variable">s</span> <span class="operator">=</span> buf.getShort();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> <span class="number">0x0FFFF</span> &amp; s;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint16</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Uint32 <span class="title function_">readUint32</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> buf.getInt();</span><br><span class="line">        <span class="type">long</span> <span class="variable">val</span> <span class="operator">=</span> <span class="number">0x0FFFFFFFFL</span> &amp; i;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint32</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Uint16[] readUint16s(Uint16 length) &#123;</span><br><span class="line">        Uint16[] table = <span class="keyword">new</span> <span class="title class_">Uint16</span>[length.value()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; table.length; i++) &#123;</span><br><span class="line">            table[i] = readUint16();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] readBytes(<span class="type">int</span> length) &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        buf.get(bytes);</span><br><span class="line">        offset += length;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工具类底层是用 <code>ByteBuffer</code> 来实现的，它提供了很多有用的方法来读取指定类型的数据，基本上可以直接使用。</p>
<h2 id="二、类文件数据结构"><a href="#二、类文件数据结构" class="headerlink" title="二、类文件数据结构"></a>二、类文件数据结构</h2><h3 id="2-1-魔数"><a href="#2-1-魔数" class="headerlink" title="2.1 魔数"></a>2.1 魔数</h3><p>很多文件格式都会规定满足该格式的文件必须以某几个固定字节开头，这几个字节主要起标识作用，叫作魔数（magic number）。</p>
<p>class 文件的魔数是 <code>0xCAFEBABE</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">magic = reader.readUint32();</span><br></pre></td></tr></table></figure>

<p>Java 虚拟机规范规定，如果加载的 class 文件不符合要求的格式，Java 虚拟机实现就抛出 <code>java.lang.ClassFormatError</code> 异常。</p>
<h3 id="2-2-版本号"><a href="#2-2-版本号" class="headerlink" title="2.2 版本号"></a>2.2 版本号</h3><p>魔数之后是 class 文件的次版本号和主版本号，都是u2类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">minorVersion = reader.readUint16();</span><br><span class="line">majorVersion = reader.readUint16();</span><br></pre></td></tr></table></figure>

<p>次版本号只在 J2SE 1.2 之前用过，从1.2开始基本上就没什么用了（都是0）。</p>
<p>主版本号在 J2SE 1.2 之前是45，从1.2开始，每次有大的 Java 版本发布，都会加1。</p>
<table>
<thead>
<tr>
<th align="center">Java 版本</th>
<th align="center">class 文件版本号</th>
</tr>
</thead>
<tbody><tr>
<td align="center">JDK 1.0.2</td>
<td align="center">45.0 ~ 45.3</td>
</tr>
<tr>
<td align="center">JDK 1.1</td>
<td align="center">45.0 ~ 45.65535</td>
</tr>
<tr>
<td align="center">J2SE 1.2</td>
<td align="center">46.0</td>
</tr>
<tr>
<td align="center">J2SE 1.3</td>
<td align="center">47.0</td>
</tr>
<tr>
<td align="center">J2SE 1.4</td>
<td align="center">48.0</td>
</tr>
<tr>
<td align="center">Java SE 5.0</td>
<td align="center">49.0</td>
</tr>
<tr>
<td align="center">Java SE 6</td>
<td align="center">50.0</td>
</tr>
<tr>
<td align="center">Java SE 7</td>
<td align="center">51.0</td>
</tr>
<tr>
<td align="center">Java SE 8</td>
<td align="center">52.0</td>
</tr>
</tbody></table>
<p>特定的 Java 虚拟机实现只能支持版本号在某个范围内的 class 文件。</p>
<p>例如，Java 8 支持版本号为 45.0 ~ 52.0 的 class 文件。</p>
<p>如果版本号不在支持的范围内，Java 虚拟机实现就抛出 <code>java.lang.UnsupportedClassVersionError</code> 异常。</p>
<h3 id="2-3-类访问标志"><a href="#2-3-类访问标志" class="headerlink" title="2.3 类访问标志"></a>2.3 类访问标志</h3><p>类访问标志，这是一个16位的 <code>bitmask</code>，用于指出 class 文件定义的是类还是接口，访问级别是 <code>public</code> 还是 <code>private</code> 等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accessFlags = reader.readUint16();</span><br></pre></td></tr></table></figure>

<h3 id="2-4-类和超类"><a href="#2-4-类和超类" class="headerlink" title="2.4 类和超类"></a>2.4 类和超类</h3><p>类访问标志之后是两个u2类型的常量池索引，分别给出类名和超类名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">className = reader.readUint16();</span><br><span class="line">superClassName = reader.readUint16();</span><br></pre></td></tr></table></figure>

<p>class 文件存储的类名类似完全限定名，但是把点（<code>.</code>）换成了斜线（<code>/</code>），这种名字叫作二进制名（binary names）。</p>
<p>比如，<code>java.lang.Object</code> 在 class 文件中存储的名称为 <code>java/lang/Object</code>。</p>
<p>每个类都要有名字，所以 <code>className</code> 必须是有效的常量池索引。</p>
<p>除 <code>java.lang.Object</code> 之外，其他类都有超类，所以除了 <code>Object.class</code> 以外，其他 class 文件中的 <code>superClassName</code> 必须是有效的常量池索引。</p>
<p>而 <code>java.lang.Object</code> 的 class 文件中，<code>superClassName</code> 的值是0。</p>
<h3 id="2-5-类接口"><a href="#2-5-类接口" class="headerlink" title="2.5 类接口"></a>2.5 类接口</h3><p>类和超类索引后面是接口索引表，表中存放的也是常量池索引，给出该类实现的所有接口的名字。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">interfaceCount = reader.readUint16();</span><br><span class="line">interfaces = reader.readUint16s(interfaceCount);</span><br></pre></td></tr></table></figure>

<h3 id="2-6-字段、方法"><a href="#2-6-字段、方法" class="headerlink" title="2.6 字段、方法"></a>2.6 字段、方法</h3><p>接口索引表之后是字段表和方法表，分别存储字段和方法信息。字段和方法的基本结构大致相同，差别仅在于属性表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">field_info &#123;</span><br><span class="line">    u2                     access_flags;</span><br><span class="line">    u2                     name_index;</span><br><span class="line">    u2                     descriptor_index;</span><br><span class="line">    u2                     attributes_count;</span><br><span class="line">    attribute_info         attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和类一样，字段和方法也有自己的访问标志。</p>
<p>访问标志之后是一个常量池索引，给出字段名或方法名。</p>
<p>然后又是一个常量池索引，给出字段或方法的描述符。</p>
<p>最后是属性表。</p>
<p>字段和方法的结构基本一致，所以它们的解析过程也差不多：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 成员变量</span></span><br><span class="line">fieldCount = reader.readUint16();</span><br><span class="line">fields = <span class="keyword">new</span> <span class="title class_">FieldInfo</span>[fieldCount.value()];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">    fields[i] = <span class="keyword">new</span> <span class="title class_">FieldInfo</span>();</span><br><span class="line">    fields[i].readFrom(reader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成员方法</span></span><br><span class="line">methodCount = reader.readUint16();</span><br><span class="line">methods = <span class="keyword">new</span> <span class="title class_">MethodInfo</span>[methodCount.value()];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">    methods[i] = <span class="keyword">new</span> <span class="title class_">MethodInfo</span>();</span><br><span class="line">    methods[i].readFrom(reader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="三、常量池"><a href="#三、常量池" class="headerlink" title="三、常量池"></a>三、常量池</h2><p>常量池里面存放着各式各样的常量信息，包括数字和字符串常量、类和接口名、字段和方法名等等。</p>
<p>常量池实际上也是一个表。表头给出的常量池大小比实际大1。</p>
<p>假设表头给出的值是n，那么常量池的实际大小是n–1。也就是说，常量池的有效的常量池索引是1~n–1。0是无效索引，表示不指向任何常量。</p>
<p><code>CONSTANT_Long_info</code> 和 <code>CONSTANT_Double_info</code> 各占两个位置。也就是说，如果常量池中存在这两种常量，实际的常量数量比n–1还要少，而且1~n–1的某些数也会变成无效索引。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">constantCount = reader.readUint16();</span><br><span class="line">constantPool = <span class="keyword">new</span> <span class="title class_">ConstantInfo</span>[constantCount.value()];</span><br><span class="line"><span class="comment">// 常量池的索引从1开始</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; constantPool.length; i++) &#123;</span><br><span class="line">    constantPool[i] = readConstantInfo(reader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双字类型（即8字节）占2个位置</span></span><br><span class="line">    <span class="keyword">if</span> (constantPool[i] <span class="keyword">instanceof</span> LongConstantInfo</span><br><span class="line">            || constantPool[i] <span class="keyword">instanceof</span> DoubleConstantInfo) &#123;</span><br><span class="line">        constantPool[++i] = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>常量的第一个字节是 tag 值，用于指明常量的类型。</p>
<p>Java 虚拟机规范定义了14种常量，各个常量值对应的 tag 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Constant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantUtf8</span> <span class="operator">=</span> <span class="number">1</span>;                <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantInteger</span> <span class="operator">=</span> <span class="number">3</span>;             <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantFloat</span> <span class="operator">=</span> <span class="number">4</span>;               <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantLong</span> <span class="operator">=</span> <span class="number">5</span>;                <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantDouble</span> <span class="operator">=</span> <span class="number">6</span>;              <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantClass</span> <span class="operator">=</span> <span class="number">7</span>;               <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantString</span> <span class="operator">=</span> <span class="number">8</span>;              <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantFieldRef</span> <span class="operator">=</span> <span class="number">9</span>;            <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantMethodRef</span> <span class="operator">=</span> <span class="number">10</span>;          <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantInterfaceMethodRef</span> <span class="operator">=</span> <span class="number">11</span>; <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantNameAndType</span> <span class="operator">=</span> <span class="number">12</span>;        <span class="comment">// Java 1.0.2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantMethodHandle</span> <span class="operator">=</span> <span class="number">15</span>;       <span class="comment">// Java 7</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantMethodType</span> <span class="operator">=</span> <span class="number">16</span>;         <span class="comment">// Java 7</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantInvokeDynamic</span> <span class="operator">=</span> <span class="number">18</span>;      <span class="comment">// Java 7</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantModule</span> <span class="operator">=</span> <span class="number">19</span>;             <span class="comment">// Java 9</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantPackage</span> <span class="operator">=</span> <span class="number">20</span>;            <span class="comment">// Java 9</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ConstantDynamic</span> <span class="operator">=</span> <span class="number">17</span>;            <span class="comment">// Java 11</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照结构，常量池的常量可以分为2种，一种是存放有数据的字面常量，一种是存放索引的引用常量。</p>
<p>像整数、浮点数、UTF8字节等，都属于字面常量；而像字符串、类型、方法等都是引用常量。</p>
<p>就比如，整数常量的结构是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Integer_info &#123;</span><br><span class="line">    3 (u1 tag);</span><br><span class="line">    101 (u4 Integer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整数常量的 <code>u4 Integer</code> 的值 101 就是这个整数常量的值，也就是它是直接保存数据的。</p>
<p>而字符串常量的结构是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_String_info &#123;</span><br><span class="line">    8 (u1 tag);</span><br><span class="line">    34 (u2 string_index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字符串常量里面的 <code>string_index</code> 就只是一个索引，指向了另外的常量，并不直接保存数据。</p>
<p>下面分别详细介绍这些常量的结构定义。</p>
<h3 id="3-1-字面常量"><a href="#3-1-字面常量" class="headerlink" title="3.1 字面常量"></a>3.1 字面常量</h3><p>字面常量，和 Java 中的基本类型概念差不多，是实际拥有数据的常量。</p>
<h4 id="3-1-1-CONSTANT-Utf8"><a href="#3-1-1-CONSTANT-Utf8" class="headerlink" title="3.1.1 CONSTANT_Utf8"></a>3.1.1 CONSTANT_Utf8</h4><p><code>CONSTANT_Utf8</code> 是一个变长的数据结构，里面存放的是 MUTF-8 编码的字符串，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Utf8_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 length;</span><br><span class="line">    u1 bytes[length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 1。</p>
<p><code>length</code> 是它的长度，u2 是2个字节，所以它的最大值为 65536。</p>
<p>这也就意味着，Java 中允许的最大字符串长度为 65536 字节。也就是能够放 65536 个 ASCII 字符，或者 65536/3 个中文字符。</p>
<p>它的读取比较直接，按照字节长度读取即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    length = reader.readUint16();</span><br><span class="line">    val = reader.readBytes(length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-CONSTANT-Integer"><a href="#3-1-2-CONSTANT-Integer" class="headerlink" title="3.1.2 CONSTANT_Integer"></a>3.1.2 CONSTANT_Integer</h4><p><code>CONSTANT_Integer</code> 是整型常量，使用4字节存储数值，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Integer_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u4 bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 3。</p>
<p>整型常量，对应的就是 Java 中的 Integer 整型，所以直接按照读取 Integer 的方式读取即可。</p>
<p>刚好 <code>ByteBuffer</code> 也提供了相应的基本类型读取方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">readInt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> buf.getInt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以在解析整型常量时，可以直接解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    val = reader.readInt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-3-CONSTANT-Float"><a href="#3-1-3-CONSTANT-Float" class="headerlink" title="3.1.3 CONSTANT_Float"></a>3.1.3 CONSTANT_Float</h4><p><code>CONSTANT_Float</code> 是 IEEE754 单精度浮点数常量，使用4字节存储数值，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Float_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u4 bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 4。</p>
<p>单精度浮点数常量，对应的就是 Java 中的 Float 单精度浮点数。</p>
<p><code>ByteBuffer</code> 也提供了相应的读取方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">readFloat</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> buf.getFloat();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就可以直接解析浮点数了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    val = reader.readFloat();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-4-CONSTANT-Long"><a href="#3-1-4-CONSTANT-Long" class="headerlink" title="3.1.4 CONSTANT_Long"></a>3.1.4 CONSTANT_Long</h4><p><code>CONSTANT_Long</code> 是8字节长整型常量，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Long_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u4 high_bytes;</span><br><span class="line">    u4 low_bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 5。</p>
<p>注意，在长整型常量定义中，8字节是被拆分成高位4字节和低位4字节来存放的。</p>
<p>长整型常量，对应的就是 Java 中的 Long 长整型。</p>
<p><code>ByteBuffer</code> 也提供了相应的读取方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">readLong</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> buf.getLong();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接解析即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    val = reader.readLong();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-5-CONSTANT-Double"><a href="#3-1-5-CONSTANT-Double" class="headerlink" title="3.1.5 CONSTANT_Double"></a>3.1.5 CONSTANT_Double</h4><p><code>CONSTANT_Double</code> 是 IEEE754 双精度浮点数常量，使用8字节存储数值，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Double_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u4 high_bytes;</span><br><span class="line">    u4 low_bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 6。</p>
<p>注意，在双精度浮点数常量定义中，8字节也是被拆分成高位4字节和低位4字节来存放的。</p>
<p>双精度浮点数常量，对应的是 Java 中的 Double 双精度浮点数。</p>
<p><code>ByteBuffer</code> 也提供了相应的读取方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">readDouble</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> buf.getDouble();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接解析即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    val = reader.readDouble();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-引用常量"><a href="#3-2-引用常量" class="headerlink" title="3.2 引用常量"></a>3.2 引用常量</h3><p>引用常量比较简单，它们不直接保存数据，只保存了索引，所以结构上可能会比字面常量稍微复杂一些。</p>
<p>下面简单介绍其中几种常见的引用常量。</p>
<h4 id="3-2-1-CONSTANT-String"><a href="#3-2-1-CONSTANT-String" class="headerlink" title="3.2.1 CONSTANT_String"></a>3.2.1 CONSTANT_String</h4><p><code>CONSTANT_String_info</code> 常量表示 <code>java.lang.String</code> 字面量，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_String_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 string_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 8。</p>
<p><code>string_index</code> 是常量池索引，指向一个 <code>CONSTANT_Utf8_info</code> 常量。</p>
<h4 id="3-2-2-CONSTANT-Class"><a href="#3-2-2-CONSTANT-Class" class="headerlink" title="3.2.2 CONSTANT_Class"></a>3.2.2 CONSTANT_Class</h4><p><code>CONSTANT_Class</code> 常量表示类或者接口的符号引用，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Class_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 name_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 7。</p>
<p><code>name_index</code> 是常量池索引，指向一个 <code>CONSTANT_Utf8_info</code> 常量。</p>
<h4 id="3-2-3-CONSTANT-Fieldref"><a href="#3-2-3-CONSTANT-Fieldref" class="headerlink" title="3.2.3 CONSTANT_Fieldref"></a>3.2.3 CONSTANT_Fieldref</h4><p><code>CONSTANT_Fieldref_info</code> 表示字段符号引用，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Fieldref_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 class_index;</span><br><span class="line">    u2 name_and_type_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 9。</p>
<p><code>class_index</code> 是所在类索引，指向一个 <code>CONSTANT_Class_info</code> 常量。</p>
<p><code>name_and_type_index</code> 是名称和类型定义索引，指向一个 <code>CONSTANT_NameAndType_info</code> 常量。</p>
<h4 id="3-2-4-CONSTANT-Methodref"><a href="#3-2-4-CONSTANT-Methodref" class="headerlink" title="3.2.4 CONSTANT_Methodref"></a>3.2.4 CONSTANT_Methodref</h4><p><code>CONSTANT_Methodref_info</code> 表示普通（非接口）方法符号引用，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Methodref_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 class_index;</span><br><span class="line">    u2 name_and_type_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 10。</p>
<p><code>class_index</code> 是所在类索引，指向一个 <code>CONSTANT_Class_info</code> 常量。</p>
<p><code>name_and_type_index</code> 是名称和类型定义索引，指向一个 <code>CONSTANT_NameAndType_info</code> 常量。</p>
<h4 id="3-2-5-CONSTANT-InterfaceMethodref"><a href="#3-2-5-CONSTANT-InterfaceMethodref" class="headerlink" title="3.2.5 CONSTANT_InterfaceMethodref"></a>3.2.5 CONSTANT_InterfaceMethodref</h4><p><code>CONSTANT_InterfaceMethodref_info</code> 表示接口方法符号引用，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_InterfaceMethodref_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 class_index;</span><br><span class="line">    u2 name_and_type_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 11。</p>
<p><code>class_index</code> 是所在接口索引，指向一个 <code>CONSTANT_Class_info</code> 常量。</p>
<p><code>name_and_type_index</code> 是名称和类型定义索引，指向一个 <code>CONSTANT_NameAndType_info</code> 常量。</p>
<h4 id="3-2-6-CONSTANT-NameAndType"><a href="#3-2-6-CONSTANT-NameAndType" class="headerlink" title="3.2.6 CONSTANT_NameAndType"></a>3.2.6 CONSTANT_NameAndType</h4><p><code>CONSTANT_NameAndType_info</code> 给出字段或方法的名称和描述符，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_NameAndType_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 name_index;</span><br><span class="line">    u2 descriptor_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tag</code> 等于 12。</p>
<p><code>name_index</code> 是名称索引，指向一个 <code>CONSTANT_Utf8_info</code> 常量。</p>
<p><code>descriptor_index</code> 是字段或方法的描述符索引，也是指向一个 <code>CONSTANT_Utf8_info</code> 常量。</p>
<p><code>CONSTANT_Class_info</code> 和 <code>CONSTANT_NameAndType_info</code> 加在一起可以唯一确定一个字段或者方法。</p>
<p>描述符的作用是用来描述字段的数据类型、方法的参数列表（包括数量、类型以及顺序）和返回值。</p>
<p>不过这里的描述符，不是常见的完整的字段或者函数定义，而是一种缩写形式，它的规则有以下几个：</p>
<ul>
<li>类型描述符<ul>
<li>基本类型byte、short、char、int、long、float和double的描述符是单个字母，分别对应B、S、C、I、J、F和D（注意，long的描述符是J而不是L）</li>
<li>引用类型的描述符是“L + 类的完全限定名 + 分号”</li>
<li>数组类型的描述符是“[ + 数组元素类型描述符”</li>
</ul>
</li>
<li>字段描述符<ul>
<li>字段描述符就是字段类型的描述符</li>
</ul>
</li>
<li>方法描述符<ul>
<li>方法描述符是“（分号分隔的参数类型描述符）+ 返回值类型描述符”，其中void返回值由单个字母V表示</li>
</ul>
</li>
</ul>
<p>这里直接举几个例子来说明：</p>
<table>
<thead>
<tr>
<th align="center">描述符</th>
<th align="center">类型</th>
</tr>
</thead>
<tbody><tr>
<td align="center">B</td>
<td align="center">byte</td>
</tr>
<tr>
<td align="center">S</td>
<td align="center">short</td>
</tr>
<tr>
<td align="center">Ljava/lang/Object;</td>
<td align="center">java.lang.Object</td>
</tr>
<tr>
<td align="center">[I</td>
<td align="center">int[]</td>
</tr>
<tr>
<td align="center">[[Ljava/lang/String;</td>
<td align="center">String[][]</td>
</tr>
<tr>
<td align="center">()V</td>
<td align="center">void method()</td>
</tr>
<tr>
<td align="center">(Ljava/lang/String;)Ljava/lang/String;</td>
<td align="center">String method(String)</td>
</tr>
<tr>
<td align="center">([JJ)J</td>
<td align="center">long method(long[], long)</td>
</tr>
<tr>
<td align="center">(Ljava/lang/String;Ljava/lang/String;)V</td>
<td align="center">void method(String, String)</td>
</tr>
</tbody></table>
<p>为了减少描述符在 ClassFile 文件中占用的空间，它只保留了必要的属性，一些不必要的属性如方法名称，并没有直接保存在描述符中。</p>
<p>Java语言支持方法重载（override），不同的方法可以有相同的名字，只要参数列表不同即可。这就是为什么<code>CONSTANT_NameAndType_info</code>结构要同时包含名称和描述符的原因。</p>
<p>那么字段呢？Java是不能定义多个同名字段的，哪怕它们的类型各不相同。这只是Java语法的限制而已，从class文件的层面来看，是完全可以支持这点的。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>常量池中的常量分为两类：字面量（literal）和符号引用（symbolic reference）。</p>
<p>字面量包括数字常量和字符串常量，符号引用包括类和接口名、字段和方法信息等。</p>
<p>除了字面量，其他引用常量都是通过索引直接或间接指向 <code>CONSTANT_Utf8_info</code> 常量。</p>
<h2 id="四、属性表"><a href="#四、属性表" class="headerlink" title="四、属性表"></a>四、属性表</h2><p>属性表可谓是个大杂烩，里面存储了各式各样的信息，如方法的字节码等。</p>
<p>常量是由Java虚拟机规范严格定义的，共有14种。但属性是可以扩展的，不同的虚拟机实现可以定义自己的属性类型。</p>
<p>由于这个原因，Java虚拟机规范没有使用tag，而是使用属性名来区别不同的属性。</p>
<p>属性数据放在属性名之后的u1表中，这样Java虚拟机实现就可以跳过自己无法识别的属性。</p>
<p>属性的结构定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">attribute_info &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u1 info[attribute_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>属性表中存放的属性名实际上并不是编码后的字符串，而是常量池索引 <code>attribute_name_index</code>，指向常量池中的 <code>CONSTANT_Utf8_info</code> 常量。</p>
<p>按照这个定义，定义了一个属性接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AttributeInfo</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体属性只要实现 <code>readFrom</code> 方法即可。</p>
<h3 id="4-1-属性类型"><a href="#4-1-属性类型" class="headerlink" title="4.1 属性类型"></a>4.1 属性类型</h3><p>Java虚拟机规范预定义了23种属性，按照用途可以分为三组：</p>
<ul>
<li>实现Java虚拟机所必需的，共有5种</li>
<li>Java类库所必需的，共有12种</li>
<li>提供给工具使用，共有6种，这组属性是可选的</li>
</ul>
<table>
<thead>
<tr>
<th align="center">属性名</th>
<th align="center">所在位置</th>
<th align="center">分组</th>
<th align="center">增加版本</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ConstantValue</td>
<td align="center">field_info</td>
<td align="center">1</td>
<td align="center">1.0.2</td>
</tr>
<tr>
<td align="center">Code</td>
<td align="center">meghod_info</td>
<td align="center">1</td>
<td align="center">1.0.2</td>
</tr>
<tr>
<td align="center">Exceptions</td>
<td align="center">method_info</td>
<td align="center">1</td>
<td align="center">1.0.2</td>
</tr>
<tr>
<td align="center">SourceFile</td>
<td align="center">ClassFile</td>
<td align="center">3</td>
<td align="center">1.0.2</td>
</tr>
<tr>
<td align="center">LineNumberTable</td>
<td align="center">Code</td>
<td align="center">3</td>
<td align="center">1.0.2</td>
</tr>
<tr>
<td align="center">LocalVariableTable</td>
<td align="center">Code</td>
<td align="center">3</td>
<td align="center">1.0.2</td>
</tr>
<tr>
<td align="center">InnerClasses</td>
<td align="center">ClassFile</td>
<td align="center">2</td>
<td align="center">1.1</td>
</tr>
<tr>
<td align="center">Synthetic</td>
<td align="center">ClassFile,field_info,method_info</td>
<td align="center">2</td>
<td align="center">1.1</td>
</tr>
<tr>
<td align="center">Deprecated</td>
<td align="center">ClassFile,field_info,method_info</td>
<td align="center">3</td>
<td align="center">1.1</td>
</tr>
<tr>
<td align="center">EnclosingMethod</td>
<td align="center">ClassFile</td>
<td align="center">2</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">Signature</td>
<td align="center">ClassFile,field_info,method_info</td>
<td align="center">2</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">SourceDebugExtension</td>
<td align="center">ClassFile</td>
<td align="center">3</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">LocalVariableTypeTable</td>
<td align="center">Code</td>
<td align="center">3</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">RunttimeVisibleAnnotations</td>
<td align="center">ClassFile,field_info,method_info</td>
<td align="center">2</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">RunttimeInvisibleAnnotations</td>
<td align="center">ClassFile,field_info,method_info</td>
<td align="center">2</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">RunttimeVisibleParameterAnnotations</td>
<td align="center">method_info</td>
<td align="center">2</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">RunttimeInvisibleParameterAnnotations</td>
<td align="center">method_info</td>
<td align="center">2</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">AnnotationDefault</td>
<td align="center">method_info</td>
<td align="center">2</td>
<td align="center">5.0</td>
</tr>
<tr>
<td align="center">StackMapTable</td>
<td align="center">Code</td>
<td align="center">1</td>
<td align="center">6</td>
</tr>
<tr>
<td align="center">BootstrapMethods</td>
<td align="center">ClassFile</td>
<td align="center">1</td>
<td align="center">7</td>
</tr>
<tr>
<td align="center">RunttimeVisibleTypeAnnotations</td>
<td align="center">ClassFile,field_info,method_info,Code</td>
<td align="center">2</td>
<td align="center">8</td>
</tr>
<tr>
<td align="center">RunttimeInvisibleTypeAnnotations</td>
<td align="center">ClassFile,field_info,method_info,Code</td>
<td align="center">2</td>
<td align="center">8</td>
</tr>
<tr>
<td align="center">MethodParameters</td>
<td align="center">method_info</td>
<td align="center">2</td>
<td align="center">8</td>
</tr>
</tbody></table>
<h3 id="4-2-属性定义"><a href="#4-2-属性定义" class="headerlink" title="4.2 属性定义"></a>4.2 属性定义</h3><h4 id="4-2-1-Deprecated和Synthetic属性"><a href="#4-2-1-Deprecated和Synthetic属性" class="headerlink" title="4.2.1 Deprecated和Synthetic属性"></a>4.2.1 Deprecated和Synthetic属性</h4><p><code>Deprecated</code> 是最简单的两种属性之一，仅起标记作用，不包含任何数据。</p>
<p>它的结构定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Deprecated_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于不包含任何数据，所以attribute_length的值必须是0。</p>
<p><code>Deprecated</code> 属性用于指出类、接口、字段或方法已经不建议使用，编译器等工具可以根据Deprecated属性输出警告信息。</p>
<p>J2SE 5.0之前,可以使用 Javadoc 提供的 <code>@deprecated</code> 标签指示编译器给类、接口、字段或方法添加 <code>Deprecated</code> 属性。</p>
<p>从J2SE 5.0开始，可以使用 <code>@Deprecated</code> 注解。</p>
<p><code>Deprecated</code> 属性不包含数据，所以它的 <code>readFrom</code> 实现为空就行了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-Synthetic"><a href="#4-2-2-Synthetic" class="headerlink" title="4.2.2 Synthetic"></a>4.2.2 Synthetic</h4><p><code>Synthetic</code> 是最简单的两种属性之一，仅起标记作用，不包含任何数据。</p>
<p>它的结构定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Synthetic_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Synthetic</code> 属性用来标记源文件中不存在、由编译器生成的类成员，引入 <code>Synthetic</code> 属性主要是为了支持嵌套类和嵌套接口。</p>
<p><code>Synthetic</code> 属性不包含数据，所以它的 <code>readFrom</code> 也是为空：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-3-SourceFile"><a href="#4-2-3-SourceFile" class="headerlink" title="4.2.3 SourceFile"></a>4.2.3 SourceFile</h4><p><code>SourceFile</code> 是可选定长属性，只会出现在 <code>ClassFile</code> 结构中，用于指出源文件名。</p>
<p>其结构定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SourceFile_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 sourcefile_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>attribute_length</code> 的值必须是2。</p>
<p><code>sourcefile_index</code> 是常量池索引，指向一个 <code>CONSTANT_Utf8_info</code> 常量。</p>
<p><code>SourceFile</code> 属性读取很简单，直接读就行了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    length = reader.readUint32();</span><br><span class="line">    nameIndex = reader.readUint16();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-4-ConstantValue"><a href="#4-2-4-ConstantValue" class="headerlink" title="4.2.4 ConstantValue"></a>4.2.4 ConstantValue</h4><p><code>ConstantValue</code> 是定长属性，只会出现在 <code>field_info</code> 结构中，用于表示常量表达式的值。</p>
<p>其结构定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ConstantValue_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 constantvalue_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>attribute_length</code> 的值必须是2。</p>
<p><code>constantvalue_index</code> 是常量池索引，指向某一个类型定义，但具体指向哪种常量因字段类型而异。</p>
<p><code>ConstantValue</code> 属性读取也很简单，也是直接读就行了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    length = reader.readUint32();</span><br><span class="line">    constantIndex = reader.readUint16();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-5-Code"><a href="#4-2-5-Code" class="headerlink" title="4.2.5 Code"></a>4.2.5 Code</h4><p><code>Code</code> 是变长属性，只存在于 <code>method_info</code> 结构中。<code>Code</code> 属性中存放字节码等方法相关信息。</p>
<p>其结构定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Code_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 max_stack;</span><br><span class="line">    u2 max_locals;</span><br><span class="line">    u4 code_length;</span><br><span class="line">    u1 code[code_length];</span><br><span class="line">    u2 exception_table_length;</span><br><span class="line">    &#123;   u2 start_pc;</span><br><span class="line">        u2 end_pc;</span><br><span class="line">        u2 handler_pc;</span><br><span class="line">        u2 catch_type;</span><br><span class="line">    &#125; exception_table[exception_table_length];</span><br><span class="line">    u2 attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>max_stack</code> 给出操作数栈的最大深度；<code>max_locals</code>给出局部变量表大小；</p>
<p>接着是字节码，存在u1表中；最后是异常处理表和属性表。</p>
<p><code>Code</code> 属性结构相对复杂一些，有几层结构，读取起来有点麻烦：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    length = reader.readUint32();</span><br><span class="line">    maxStack = reader.readUint16();</span><br><span class="line">    maxLocals = reader.readUint16();</span><br><span class="line">    codeLength = reader.readUint32();</span><br><span class="line">    codes = reader.readBytes(codeLength);</span><br><span class="line">    exceptionLength = reader.readUint16();</span><br><span class="line">    exceptionEntries = <span class="keyword">new</span> <span class="title class_">ExceptionTableEntry</span>[exceptionLength.value()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; exceptionEntries.length; i++) &#123;</span><br><span class="line">        exceptionEntries[i] = readExceptionEntry(reader);</span><br><span class="line">    &#125;</span><br><span class="line">    attributeInfoTable = <span class="keyword">new</span> <span class="title class_">AttributeInfoTable</span>();</span><br><span class="line">    attributeInfoTable.readFrom(reader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ExceptionTableEntry <span class="title function_">readExceptionEntry</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    <span class="type">ExceptionTableEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExceptionTableEntry</span>();</span><br><span class="line">    entry.setStartPC(reader.readUint16());</span><br><span class="line">    entry.setEndPC(reader.readUint16());</span><br><span class="line">    entry.setHandlerPC(reader.readUint16());</span><br><span class="line">    entry.setCatchPC(reader.readUint16());</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-6-Exceptions"><a href="#4-2-6-Exceptions" class="headerlink" title="4.2.6 Exceptions"></a>4.2.6 Exceptions</h4><p><code>Exceptions</code> 是变长属性，记录方法抛出的异常表。</p>
<p>其结构定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Exceptions_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 number_of_exceptions;</span><br><span class="line">    u2 exception_index_table[number_of_exceptions];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Exceptions</code> 属性简单，直接读取即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    length = reader.readUint32();</span><br><span class="line">    numberOfExceptions = reader.readUint16();</span><br><span class="line">    exceptionIndexTable = reader.readUint16s(numberOfExceptions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-7-LineNumberTable"><a href="#4-2-7-LineNumberTable" class="headerlink" title="4.2.7 LineNumberTable"></a>4.2.7 LineNumberTable</h4><p><code>LineNumberTable</code> 属性表存放方法的行号信息。</p>
<p>结构定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LineNumberTable_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 line_number_table_length;</span><br><span class="line">    &#123;   u2 start_pc;</span><br><span class="line">        u2 line_number;</span><br><span class="line">    &#125; line_number_table[line_number_table_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LineNumberTable</code> 属性表不算复杂，可以直接读取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFrom</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    length = reader.readUint32();</span><br><span class="line">    lineNumberLength = reader.readUint16();</span><br><span class="line">    lineNumberEntries = <span class="keyword">new</span> <span class="title class_">LineNumberTableEntry</span>[lineNumberLength.value()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; lineNumberEntries.length; i++) &#123;</span><br><span class="line">        lineNumberEntries[i] = readLineNumberTableEntry(reader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> LineNumberTableEntry <span class="title function_">readLineNumberTableEntry</span><span class="params">(ClassReader reader)</span> &#123;</span><br><span class="line">    <span class="type">LineNumberTableEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LineNumberTableEntry</span>();</span><br><span class="line">    entry.setStartPC(reader.readUint16());</span><br><span class="line">    entry.setLineNumber(reader.readUint16());</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>相对于常量来说，属性的结构要稍微复杂一些，毕竟是可以扩展的，不像常量池常量那样基本都是固定的。</p>
<p>虽然属性的机构稍微复杂一些，但是层次还是比较清晰的。</p>
<h2 id="五、单元测试"><a href="#五、单元测试" class="headerlink" title="五、单元测试"></a>五、单元测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassFileStructureTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> <span class="variable">bt</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">short</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">4L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="variable">f</span> <span class="operator">=</span> <span class="number">5.0F</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">6.0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">short</span> <span class="variable">s</span> <span class="operator">=</span> -<span class="number">10</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> s;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ii</span> <span class="operator">=</span> s &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">si</span> <span class="operator">=</span> ss | i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Class File Test&quot;</span> + i + <span class="string">&quot; &quot;</span> + ii + <span class="string">&quot; &quot;</span> + si);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassFileTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getClassName</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jreOption</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cpOption</span> <span class="operator">=</span> <span class="string">&quot;C:\\IdeaProjects\\self-jvm\\target;C:\\IdeaProjects\\self-jvm\\target\\classes&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bootClassName</span> <span class="operator">=</span> <span class="string">&quot;java\\lang\\Object&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userClassName</span> <span class="operator">=</span> <span class="string">&quot;com\\wjd\\classfile\\ClassFileStructureTest&quot;</span>;</span><br><span class="line">        <span class="type">Classpath</span> <span class="variable">classpath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Classpath</span>(jreOption, cpOption);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bootClassBytes = classpath.readClass(bootClassName);</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">bootReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bootClassBytes);</span><br><span class="line">        <span class="type">ClassFile</span> <span class="variable">bootClassFile</span> <span class="operator">=</span> ClassFile.parse(bootReader);</span><br><span class="line">        assertEquals(<span class="string">&quot;Class name error&quot;</span>, <span class="string">&quot;java/lang/Object&quot;</span>, bootClassFile.getClassName());</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] userClassBytes = classpath.readClass(userClassName);</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">userReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(userClassBytes);</span><br><span class="line">        <span class="type">ClassFile</span> <span class="variable">userClassFile</span> <span class="operator">=</span> ClassFile.parse(userReader);</span><br><span class="line">        assertEquals(<span class="string">&quot;Class name error&quot;</span>, <span class="string">&quot;com/wjd/classfile/ClassFileStructureTest&quot;</span>, userClassFile.getClassName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>class 文件：</p>
<ul>
<li>Java 虚拟机规范中所指的 class 文件，并非特指位于磁盘中的 .class 文件，而是泛指任何格式符合规范的 class 数据。它实际上可以通过网络下载，从数据库加载，甚至是在运行中直接生成等方式来获取 class 文件<ul>
<li>构成 class 文件的基本数据单位是字节，可以把整个 class 文件当成一个字节流来处理</li>
<li>数据由连续多个字节构成，这些数据在 class 文件中以大端（big-endian）方式存储</li>
</ul>
</li>
<li>为了描述 class 文件格式，Java 虚拟机规范定义了 u1、u2 和 u4 三种数据类型来表示1、2和4字节无符号整数</li>
<li>相同类型的多条数据一般按表（table）的形式存储在 class 文件中</li>
<li>表由表头和表项（item）构成，表头是 u2 或 u4 整数</li>
</ul>
<p>常量池：</p>
<ul>
<li>常量池里面存放着各式各样的常量信息，包括数字和字符串常量、类和接口名、字段和方法名等等</li>
<li>常量池实际上也是一个表。表头给出的常量池大小比实际大1<ul>
<li>假设表头给出的值是n，那么常量池的实际大小是n–1。也就是说，常量池的有效的常量池索引是1~n–1。0是无效索引，表示不指向任何常量</li>
<li><code>long</code> 和 <code>double</code> 各占两个位置。也就是说，如果常量池中存在这两种常量，实际的常量数量比n–1还要少，而且1~n–1的某些数也会变成无效索引</li>
</ul>
</li>
<li>按照结构，常量池的常量可以分为2种，一种是存放有数据的字面常量（literal），一种是存放索引的符号引用常量（symbolic reference）<ul>
<li>字面量包括数字常量和字符串常量，符号引用包括类和接口名、字段和方法信息等</li>
<li>像整数、浮点数、UTF8字节等，都属于字面常量，直接存放数据</li>
<li>而像字符串、类型、方法等都是引用常量，不直接存放数据，只保存指向数据的索引</li>
<li>除了字面量，其他引用常量都是通过索引直接或间接指向 <code>CONSTANT_Utf8_info</code> 常量</li>
</ul>
</li>
</ul>
<p>属性：</p>
<ul>
<li>Java虚拟机规范没有使用tag，而是使用属性名来区别不同的属性</li>
<li>常量是由Java虚拟机规范严格定义的，共有14种。但属性是可以扩展的，不同的虚拟机实现可以定义自己的属性类型</li>
</ul>
</div><div class="level is-mobile is-flex"><div class="article-licensing box"><div class="licensing-title"><p>03_解析class文件</p><p><a href="http://example.com/lang/java/jvm/selfjvm/03_classfile/">http://example.com/lang/java/jvm/selfjvm/03_classfile/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>jiaduo</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-10-08</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-04-03</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/java/">java, </a><a class="link-muted" rel="tag" href="/tags/JVM/">JVM </a></div><!--!--></div></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/lang/java/core/basic/01_types/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">01_基本类型</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/lang/java/jvm/selfjvm/02_classpath/"><span class="level-item">02_查找class文件</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#解析class文件"><span class="level-left"><span class="level-item">解析class文件</span></span></a></li><li><a class="level is-mobile" href="#一、前期准备"><span class="level-left"><span class="level-item">一、前期准备</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-自定义数据类型"><span class="level-left"><span class="level-item">1.1 自定义数据类型</span></span></a></li><li><a class="level is-mobile" href="#1-2-类型数据读取"><span class="level-left"><span class="level-item">1.2 类型数据读取</span></span></a></li></ul></li><li><a class="level is-mobile" href="#二、类文件数据结构"><span class="level-left"><span class="level-item">二、类文件数据结构</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-魔数"><span class="level-left"><span class="level-item">2.1 魔数</span></span></a></li><li><a class="level is-mobile" href="#2-2-版本号"><span class="level-left"><span class="level-item">2.2 版本号</span></span></a></li><li><a class="level is-mobile" href="#2-3-类访问标志"><span class="level-left"><span class="level-item">2.3 类访问标志</span></span></a></li><li><a class="level is-mobile" href="#2-4-类和超类"><span class="level-left"><span class="level-item">2.4 类和超类</span></span></a></li><li><a class="level is-mobile" href="#2-5-类接口"><span class="level-left"><span class="level-item">2.5 类接口</span></span></a></li><li><a class="level is-mobile" href="#2-6-字段、方法"><span class="level-left"><span class="level-item">2.6 字段、方法</span></span></a></li></ul></li><li><a class="level is-mobile" href="#三、常量池"><span class="level-left"><span class="level-item">三、常量池</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-字面常量"><span class="level-left"><span class="level-item">3.1 字面常量</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-1-CONSTANT-Utf8"><span class="level-left"><span class="level-item">3.1.1 CONSTANT_Utf8</span></span></a></li><li><a class="level is-mobile" href="#3-1-2-CONSTANT-Integer"><span class="level-left"><span class="level-item">3.1.2 CONSTANT_Integer</span></span></a></li><li><a class="level is-mobile" href="#3-1-3-CONSTANT-Float"><span class="level-left"><span class="level-item">3.1.3 CONSTANT_Float</span></span></a></li><li><a class="level is-mobile" href="#3-1-4-CONSTANT-Long"><span class="level-left"><span class="level-item">3.1.4 CONSTANT_Long</span></span></a></li><li><a class="level is-mobile" href="#3-1-5-CONSTANT-Double"><span class="level-left"><span class="level-item">3.1.5 CONSTANT_Double</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-2-引用常量"><span class="level-left"><span class="level-item">3.2 引用常量</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-2-1-CONSTANT-String"><span class="level-left"><span class="level-item">3.2.1 CONSTANT_String</span></span></a></li><li><a class="level is-mobile" href="#3-2-2-CONSTANT-Class"><span class="level-left"><span class="level-item">3.2.2 CONSTANT_Class</span></span></a></li><li><a class="level is-mobile" href="#3-2-3-CONSTANT-Fieldref"><span class="level-left"><span class="level-item">3.2.3 CONSTANT_Fieldref</span></span></a></li><li><a class="level is-mobile" href="#3-2-4-CONSTANT-Methodref"><span class="level-left"><span class="level-item">3.2.4 CONSTANT_Methodref</span></span></a></li><li><a class="level is-mobile" href="#3-2-5-CONSTANT-InterfaceMethodref"><span class="level-left"><span class="level-item">3.2.5 CONSTANT_InterfaceMethodref</span></span></a></li><li><a class="level is-mobile" href="#3-2-6-CONSTANT-NameAndType"><span class="level-left"><span class="level-item">3.2.6 CONSTANT_NameAndType</span></span></a></li></ul></li><li><a class="level is-mobile" href="#小结"><span class="level-left"><span class="level-item">小结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#四、属性表"><span class="level-left"><span class="level-item">四、属性表</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-属性类型"><span class="level-left"><span class="level-item">4.1 属性类型</span></span></a></li><li><a class="level is-mobile" href="#4-2-属性定义"><span class="level-left"><span class="level-item">4.2 属性定义</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-2-1-Deprecated和Synthetic属性"><span class="level-left"><span class="level-item">4.2.1 Deprecated和Synthetic属性</span></span></a></li><li><a class="level is-mobile" href="#4-2-2-Synthetic"><span class="level-left"><span class="level-item">4.2.2 Synthetic</span></span></a></li><li><a class="level is-mobile" href="#4-2-3-SourceFile"><span class="level-left"><span class="level-item">4.2.3 SourceFile</span></span></a></li><li><a class="level is-mobile" href="#4-2-4-ConstantValue"><span class="level-left"><span class="level-item">4.2.4 ConstantValue</span></span></a></li><li><a class="level is-mobile" href="#4-2-5-Code"><span class="level-left"><span class="level-item">4.2.5 Code</span></span></a></li><li><a class="level is-mobile" href="#4-2-6-Exceptions"><span class="level-left"><span class="level-item">4.2.6 Exceptions</span></span></a></li><li><a class="level is-mobile" href="#4-2-7-LineNumberTable"><span class="level-left"><span class="level-item">4.2.7 LineNumberTable</span></span></a></li></ul></li><li><a class="level is-mobile" href="#小结-1"><span class="level-left"><span class="level-item">小结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#五、单元测试"><span class="level-left"><span class="level-item">五、单元测试</span></span></a></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">总结</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="追来者之人" height="28"></a><p class="is-size-7"><span>&copy; 2023 jiaduo</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>