<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>05_指令集和解释器 - 追来者之人</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="追来者之人"><meta name="msapplication-TileImage" content="/img/logo.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="追来者之人"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="指令集和解释器Java虚拟机顾名思义，就是一台虚拟的机器，而字节码（bytecode）就是运行在这台虚拟机器上的机器码。 一、字节码指令1.1 指令结构字节码中存放编码后的 Java 虚拟机指令：  每条指令都以一个单字节的操作码（opcode）开头。  由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令。   到第八版为止，Java 虚拟机规范已经定义了205条指令，操作码"><meta property="og:type" content="blog"><meta property="og:title" content="05_指令集和解释器"><meta property="og:url" content="http://example.com/lang/java/jvm/selfjvm/05_instruction/"><meta property="og:site_name" content="追来者之人"><meta property="og:description" content="指令集和解释器Java虚拟机顾名思义，就是一台虚拟的机器，而字节码（bytecode）就是运行在这台虚拟机器上的机器码。 一、字节码指令1.1 指令结构字节码中存放编码后的 Java 虚拟机指令：  每条指令都以一个单字节的操作码（opcode）开头。  由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令。   到第八版为止，Java 虚拟机规范已经定义了205条指令，操作码"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/java.png"><meta property="article:published_time" content="2022-02-20T16:13:21.000Z"><meta property="article:modified_time" content="2023-04-02T17:55:24.435Z"><meta property="article:author" content="jiaduo"><meta property="article:tag" content="java"><meta property="article:tag" content="JVM"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/java.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/lang/java/jvm/selfjvm/05_instruction/"},"headline":"05_指令集和解释器","image":["http://example.com/img/java.png"],"datePublished":"2022-02-20T16:13:21.000Z","dateModified":"2023-04-02T17:55:24.435Z","author":{"@type":"Person","name":"jiaduo"},"publisher":{"@type":"Organization","name":"追来者之人","logo":{"@type":"ImageObject","url":"http://example.com/img/logo.png"}},"description":"指令集和解释器Java虚拟机顾名思义，就是一台虚拟的机器，而字节码（bytecode）就是运行在这台虚拟机器上的机器码。 一、字节码指令1.1 指令结构字节码中存放编码后的 Java 虚拟机指令：  每条指令都以一个单字节的操作码（opcode）开头。  由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令。   到第八版为止，Java 虚拟机规范已经定义了205条指令，操作码"}</script><link rel="canonical" href="http://example.com/lang/java/jvm/selfjvm/05_instruction/"><link rel="icon" href="/img/logo.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="追来者之人" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-3 is-size-4-mobile"><i class="fas fa-blog"> </i>05_指令集和解释器</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="fas fa-calendar-plus"> </i><time dateTime="2022-02-20T16:13:21.000Z" title="2022-02-20T16:13:21.000Z">2022-02-21</time></span><span class="level-item is-hidden-mobile"><i class="fas fa-calendar-check"> </i><time dateTime="2023-04-02T17:55:24.435Z" title="2023-04-02T17:55:24.435Z">2023-04-03</time></span><span class="level-item"><i class="fas fa-folder"> </i><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a><span> / </span><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/">Java</a></span><span class="level-item"><i class="fas fa-clock"> </i>1 小时读完 (大约7859个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><div class="content"><h1 id="指令集和解释器"><a href="#指令集和解释器" class="headerlink" title="指令集和解释器"></a>指令集和解释器</h1><p>Java虚拟机顾名思义，就是一台虚拟的机器，而字节码（bytecode）就是运行在这台虚拟机器上的机器码。</p>
<h2 id="一、字节码指令"><a href="#一、字节码指令" class="headerlink" title="一、字节码指令"></a>一、字节码指令</h2><h3 id="1-1-指令结构"><a href="#1-1-指令结构" class="headerlink" title="1.1 指令结构"></a>1.1 指令结构</h3><p>字节码中存放编码后的 Java 虚拟机指令：</p>
<ul>
<li><p>每条指令都以一个单字节的操作码（opcode）开头。</p>
</li>
<li><p>由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令。</p>
</li>
</ul>
<p>到第八版为止，Java 虚拟机规范已经定义了205条指令，操作码分别是<code>0(0x00)</code>到 <code>202(0xCA)</code>、<code>254(0xFE)</code>和 <code>255(0xFF)</code>。</p>
<span id="more"></span>

<ul>
<li>Java虚拟机使用的是变长指令，操作码后面可以跟零字节或多字节的操作数（operand）。</li>
</ul>
<p>比如 <code>0xB20002</code> 这条指令，<code>B2</code> 表示该指令的操作码，<code>0002</code> 就表示操作数。</p>
<h3 id="1-2-指令助记符"><a href="#1-2-指令助记符" class="headerlink" title="1.2 指令助记符"></a>1.2 指令助记符</h3><p>为了便于记忆，Java虚拟机规范给每个操作码都指定了一个助记符（mnemonic）。</p>
<p>比如，操作码是 <code>0x00</code> 的助记符是 <code>nop</code>（no operation）。</p>
<ul>
<li><p>操作数栈和局部变量表只存放数据的值（Slot），并不记录数据类型。</p>
</li>
<li><p>所以指令必须知道自己在操作什么类型的数据，即指令绑定了数据类型</p>
</li>
</ul>
<p>例如，<code>iadd</code> 指令就是对 int 值进行加法操作；<code>dstore</code> 指令把操作数栈顶的double值弹出，存储到局部变量表中；<code>areturn</code> 从方法中返回引用值。</p>
<h3 id="1-3-指令类型"><a href="#1-3-指令类型" class="headerlink" title="1.3 指令类型"></a>1.3 指令类型</h3><p>Java 虚拟机规范把已经定义的205条指令按用途分成了11类，分别是：</p>
<ul>
<li>常量（constants）指令</li>
<li>加载（loads）指令</li>
<li>存储（stores）指令</li>
<li>操作数栈（stack）指令</li>
<li>数学（math）指令</li>
<li>转换（conversions）指令</li>
<li>比较（comparisons）指令</li>
<li>控制（control）指令</li>
<li>引用（references）指令</li>
<li>扩展（extended）指令</li>
<li>保留（reserved）指令</li>
</ul>
<p>保留指令一共有3条。</p>
<ul>
<li><p>其中1条是留给调试器的，用于实现断点，操作码是 <code>202(0xCA)</code>，助记符是 <code>breakpoint</code>；</p>
</li>
<li><p>另外2条留给 Java 虚拟机实现内部使用，操作码分别是 <code>254(0xFE)</code> 和 <code>266(0xFF)</code>，助记符是 <code>impdep1</code> 和 <code>impdep2</code>。</p>
</li>
</ul>
<p>这3条保留指令不允许出现在class文件中。</p>
<h2 id="二、指令运行"><a href="#二、指令运行" class="headerlink" title="二、指令运行"></a>二、指令运行</h2><h3 id="2-1-指令循环"><a href="#2-1-指令循环" class="headerlink" title="2.1 指令循环"></a>2.1 指令循环</h3><p>虚拟机的运行过程，就是循环执行指令的过程，伪代码大致是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    atomically calculate pc and fetch opcode at pc;</span><br><span class="line">    <span class="keyword">if</span> (operands) fetch operands;</span><br><span class="line">    execute the action <span class="keyword">for</span> the opcode;</span><br><span class="line">&#125; <span class="keyword">while</span> (there is more to <span class="keyword">do</span>);</span><br></pre></td></tr></table></figure>

<p>每次循环都包含三个部分：</p>
<ol>
<li>计算pc</li>
<li>指令解码</li>
<li>指令执行</li>
</ol>
<p>上面的伪代码转成 java 代码的话，大概是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 计算PC</span></span><br><span class="line">    pc = calculatePC()</span><br><span class="line">    <span class="comment">// 指令解码</span></span><br><span class="line">    opcode = bytecode[pc]</span><br><span class="line">    inst = createInst(opcode)</span><br><span class="line">    inst.fetchOperands(bytecode)</span><br><span class="line">    <span class="comment">// 指令执行</span></span><br><span class="line">    inst.execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-指令接口"><a href="#2-2-指令接口" class="headerlink" title="2.2 指令接口"></a>2.2 指令接口</h3><p>根据上述的伪代码，创建指令接口 <code>Instruction</code>，作为所有指令实现的基本接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口包括2个方法：取数（<code>fetchOperands</code>）和执行（<code>execute</code>）。</p>
<h3 id="2-2-指令解码"><a href="#2-2-指令解码" class="headerlink" title="2.2 指令解码"></a>2.2 指令解码</h3><p>接下来就是怎么把字节码解析成指令接口了。</p>
<p>因为需要操作字节，所以定义字节码读取类 <code>ByteCodeReader</code>，用于读取字节码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ByteCodeReader</span> &#123;</span><br><span class="line">    <span class="comment">/** 字节码字节数组 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] bytes;</span><br><span class="line">    <span class="comment">/** 字节缓冲读取 */</span></span><br><span class="line">    <span class="keyword">private</span> ByteBuffer buf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ByteCodeReader</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        reset(bytes, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">(<span class="type">byte</span>[] bytes, <span class="type">int</span> position)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bytes = bytes;</span><br><span class="line">        buf = ByteBuffer.wrap(bytes);</span><br><span class="line">        buf.order(ByteOrder.BIG_ENDIAN); <span class="comment">// 大端</span></span><br><span class="line">        buf.position(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPosition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.position();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">readByte</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">readShort</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.getShort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">readInt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.getInt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">readInt8</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> readByte();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Uint8 <span class="title function_">readUint8</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> buf.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> <span class="number">0x0FF</span> &amp; b;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">readInt16</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> readShort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Uint16 <span class="title function_">readUint16</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">short</span> <span class="variable">s</span> <span class="operator">=</span> buf.getShort();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> <span class="number">0x0FFFF</span> &amp; s;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint16</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Uint32 <span class="title function_">readUint32</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> buf.getInt();</span><br><span class="line">        <span class="type">long</span> <span class="variable">val</span> <span class="operator">=</span> <span class="number">0x0FFFFFFFFL</span> &amp; i;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint32</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] readBytes(Uint32 length) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> (<span class="type">int</span>) length.value();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line">        buf.get(bytes);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">skipPadding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (getPosition() % <span class="number">4</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            readUint8();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>bytes</code> 存放原始的字节码字节数组，<code>buf</code> 是 java 中的 <code>ByteBuffer</code> 类对象，可以对字节进行操作。</p>
<p>因为有些数据是占用不止1个机器字的，所以需要定义字节数组是大端，还是小端，这里设定是大端。</p>
<p><code>getPosition()</code> 可用于获取当前读到的位置，这个主要是用于后面程序计数器 PC 的定位。</p>
<p>剩余的则是读取不同数据格式的方法，和 classfile 的读取差不多。</p>
<h2 id="三、指令集"><a href="#三、指令集" class="headerlink" title="三、指令集"></a>三、指令集</h2><h3 id="3-1-抽象指令基类"><a href="#3-1-抽象指令基类" class="headerlink" title="3.1 抽象指令基类"></a>3.1 抽象指令基类</h3><p>接口包括2个方法：取数（<code>fetchOperands</code>）和执行（<code>execute</code>）。</p>
<p>很多指令都具有相同的操作数类型，所以定义一些基类来方便实现。</p>
<p>有些指令是没有操作数的，定义一个无操作数基类 <code>NoOperandsInstruction</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoOperandsInstruction</span> <span class="keyword">implements</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="comment">// 什么也不做</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        <span class="comment">// 什么也不做</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有些指令需要访问局部变量表，局部变量表索引是一个8位无符号整数，定义一个基类 <code>Index8Instruction</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Index8Instruction</span> <span class="keyword">implements</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> index;</span><br><span class="line">    <span class="keyword">protected</span> Uint8 source;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        source = reader.readUint8();</span><br><span class="line">        index = source.value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有些指令需要访问常量池，常量池索引是一个16位无符号整数，定义一个基类 <code>Index16Instruction</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Index16Instruction</span> <span class="keyword">implements</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> index;</span><br><span class="line">    <span class="keyword">protected</span> Uint16 source;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        source = reader.readUint16();</span><br><span class="line">        index = source.value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有跳转指令，它的操作数是16位无符号整数，定义基类 <code>BranchInstruction</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BranchInstruction</span> <span class="keyword">implements</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 16位有符号整数偏移 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> offset;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        <span class="comment">// 注意是16位有符号整数</span></span><br><span class="line">        offset = reader.readShort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指令跳转</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> frame 栈帧</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">branch</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pc</span> <span class="operator">=</span> frame.getThread().getPc();</span><br><span class="line">        frame.setNextPc(pc + offset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-常量（constants）指令"><a href="#3-2-常量（constants）指令" class="headerlink" title="3.2 常量（constants）指令"></a>3.2 常量（constants）指令</h3><p>常量指令，把常量推入操作数栈顶。</p>
<p>常量的来源有3个：</p>
<ul>
<li>隐含在操作码</li>
<li>操作数</li>
<li>运行时常量池</li>
</ul>
<p>下面是这几种常量来源的具体实现。</p>
<h4 id="3-2-1-隐含在操作码的常量"><a href="#3-2-1-隐含在操作码的常量" class="headerlink" title="3.2.1 隐含在操作码的常量"></a>3.2.1 隐含在操作码的常量</h4><p>所谓的隐含在操作码里，实际上指令绑定了常量，在助记符里就能看出来常量值。</p>
<p>比如指令 <code>iconst_3</code>，就是整数常量3；<code>iconst_m1</code> 就是整数常量-1；<code>dconst_1</code> 就是双精度浮点数1。</p>
<p>这种隐含在操作码的指定，有15条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">aconst_null</span><br><span class="line">iconst_m1</span><br><span class="line">iconst_0</span><br><span class="line">iconst_1</span><br><span class="line">iconst_2</span><br><span class="line">iconst_3</span><br><span class="line">iconst_4</span><br><span class="line">iconst_5</span><br><span class="line">lconst_0</span><br><span class="line">lconst_1</span><br><span class="line">fconst_0</span><br><span class="line">fconst_1</span><br><span class="line">fconst_2</span><br><span class="line">dconst_0</span><br><span class="line">dconst_1</span><br></pre></td></tr></table></figure>

<p>指令这些隐藏常量，是因为这些常量比较常用，懒得浪费1个字节去额外存储。</p>
<p><code>aconst_null</code> 指令把 <code>null</code> 引用推入操作数栈顶：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AConstNull</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().pushRef(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>iconst_m1</code> 指令把 <code>int</code> 型 -1 推入操作数栈顶：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IConstM1</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().pushInt(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dconst_0</code> 指令把 <code>double</code> 型 0 推入操作数栈顶：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DConst0</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().pushDouble(<span class="number">0.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其余常量指令代码都差不多，只是值不同，不再列出。</p>
<h4 id="3-2-2-操作数常量"><a href="#3-2-2-操作数常量" class="headerlink" title="3.2.2 操作数常量"></a>3.2.2 操作数常量</h4><p>有2个指令，是把操作数当作常量，放入操作数栈中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bipush</span><br><span class="line">sipush</span><br></pre></td></tr></table></figure>

<p><code>bipush</code> 是从操作数中读取一个 <code>byte</code> 整数，放入操作数栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BIPush</span> <span class="keyword">implements</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        <span class="comment">// 注意是8位有符号整数</span></span><br><span class="line">        val = reader.readInt8();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sipush</code> 是从操作数中读取一个 <code>short</code> 整数，放入操作数栈中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SIPush</span> <span class="keyword">implements</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        <span class="comment">// 注意是16位有符号整数</span></span><br><span class="line">        val = reader.readInt16();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，<code>bipush</code> 和 <code>sipush</code> 的操作数都是有符号整数。</p>
<h4 id="3-2-3-常量池常量"><a href="#3-2-3-常量池常量" class="headerlink" title="3.2.3 常量池常量"></a>3.2.3 常量池常量</h4><p>还有几条指令，是从常量池中获取常量，放入操作数栈中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">idc</span><br><span class="line">idcw</span><br><span class="line">idc2w</span><br></pre></td></tr></table></figure>

<p><code>idc</code> 的操作数是8位无符号整数，用于获取 <code>int</code>、<code>float</code> 这些类型的常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDC</span> <span class="keyword">extends</span> <span class="title class_">Index8Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">OperandStack</span> <span class="variable">stack</span> <span class="operator">=</span> frame.getOpStack();</span><br><span class="line">        <span class="type">ConstantPool</span> <span class="variable">cp</span> <span class="operator">=</span> frame.getMethod().getClazz().getConstantPool();</span><br><span class="line">        <span class="type">Constant</span> <span class="variable">constant</span> <span class="operator">=</span> cp.getConstant(index);</span><br><span class="line">        <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> IntegerConstant) &#123;</span><br><span class="line">            stack.pushInt(((IntegerConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> FloatConstant) &#123;</span><br><span class="line">            stack.pushFloat(((FloatConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Unsupported Type: &quot;</span> + constant);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>idcw</code> 的操作数是16位无符号整数，用于获取 <code>int</code>、<code>float</code> 这些类型的常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDCW</span> <span class="keyword">extends</span> <span class="title class_">Index16Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">OperandStack</span> <span class="variable">stack</span> <span class="operator">=</span> frame.getOpStack();</span><br><span class="line">        <span class="type">ConstantPool</span> <span class="variable">cp</span> <span class="operator">=</span> frame.getMethod().getClazz().getConstantPool();</span><br><span class="line">        <span class="type">Constant</span> <span class="variable">constant</span> <span class="operator">=</span> cp.getConstant(index);</span><br><span class="line">        <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> IntegerConstant) &#123;</span><br><span class="line">            stack.pushInt(((IntegerConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> FloatConstant) &#123;</span><br><span class="line">            stack.pushFloat(((FloatConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Unsupported Type: &quot;</span> + constant);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>idc2w</code> 的操作数是16位无符号整数，用于获取 <code>long</code>、<code>double</code> 类型的常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IDC2W</span> <span class="keyword">extends</span> <span class="title class_">Index16Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">OperandStack</span> <span class="variable">stack</span> <span class="operator">=</span> frame.getOpStack();</span><br><span class="line">        <span class="type">ConstantPool</span> <span class="variable">cp</span> <span class="operator">=</span> frame.getMethod().getClazz().getConstantPool();</span><br><span class="line">        <span class="type">Constant</span> <span class="variable">constant</span> <span class="operator">=</span> cp.getConstant(index);</span><br><span class="line">        <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> LongConstant) &#123;</span><br><span class="line">            stack.pushLong(((LongConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> DoubleConstant) &#123;</span><br><span class="line">            stack.pushDouble(((DoubleConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassFormatError</span>(<span class="string">&quot;Constant: &quot;</span> + constant);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>idc</code>、<code>idcw</code> 的作用差不多，只是操作数的范围不一样。</p>
<p><code>idc2w</code> 是专门用于 <code>long</code>、<code>double</code> 这种双字类型的指令。</p>
<h3 id="3-3-加载（loads）指令"><a href="#3-3-加载（loads）指令" class="headerlink" title="3.3 加载（loads）指令"></a>3.3 加载（loads）指令</h3><p>加载指令，负责从局部变量表获取变量，然后推入操作数栈顶。</p>
<p>加载指令共33条。</p>
<p>按照操作数类型分的话，可以分为6种：</p>
<ul>
<li>aload 系列指令：操作引用类型变量</li>
<li>dload 系列指令：操作 double 类型变量</li>
<li>fload 系列指令：操作 float 变量</li>
<li>iload 系列指令：操作 int 变量</li>
<li>lload 系列指令：操作 long 变量</li>
<li>xaload 系列指令：操作数组变量</li>
</ul>
<p>实际上各个加载指令都差不多，只是操作数的类型不同。</p>
<p>从局部变量表中获取变量，需要指定变量索引，索引的来源有2个：</p>
<ul>
<li>隐含在操作码中</li>
<li>操作数</li>
</ul>
<p>这2种来源和前面的常量指令差不多。</p>
<p>这里给几个例子：</p>
<p><code>iload_1</code> 指令，把局部变量表中的 1 号整型变量，推入操作数栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ILoad1</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().pushInt(frame.getLocalVars().getInt(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dload_2</code> 指令，把局部变量表中的 2 号 <code>double</code> 变量，推入操作数栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DLoad2</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().pushDouble(frame.getLocalVars().getDouble(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>lload</code> 指令，从操作数中获取索引 index，根据索引去局部变量表中加载第 index 号的 <code>long</code> 变量，推入操作数栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLoad</span> <span class="keyword">extends</span> <span class="title class_">Index8Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="comment">// index 是 Index8Instruction 读取的8位无符号整数</span></span><br><span class="line">        frame.getOpStack().pushLong(frame.getLocalVars().getLong(index));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似的指令还有 <code>iload</code>、<code>fload</code>、<code>dload</code>、<code>aload</code> 等。</p>
<p>需要注意，<code>long</code>、<code>double</code> 类型实际上是会占用局部变量表和操作数栈的2个插槽 Slot 的，之前已经封装好了。</p>
<h3 id="3-4-存储（stores）指令"><a href="#3-4-存储（stores）指令" class="headerlink" title="3.4 存储（stores）指令"></a>3.4 存储（stores）指令</h3><p>存储指令，负责从操作数栈中弹出变量，放入局部变量表中。</p>
<p>存储指令和加载指令是反过来操作的，所以指令都差不多，实现也就是反过来就行。</p>
<p>这里给几个例子：</p>
<p><code>astore_0</code> 指令，从操作数栈中弹出引用变量，放入局部变量表的 0 号位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AStore0</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getLocalVars().setRef(<span class="number">0</span>, frame.getOpStack().popRef());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fstore_2</code> 指令，从操作数栈中弹出 <code>float</code> 变量，放入局部变量表的 2 号位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FStore2</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getLocalVars().setFloat(<span class="number">2</span>, frame.getOpStack().popFloat());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dstore</code> 指令，在操作数中获取索引 index，从操作数栈中弹出 <code>double</code> 变量，放入局部变量表的 index 号位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DStore</span> <span class="keyword">extends</span> <span class="title class_">Index8Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="comment">// index 是 Index8Instruction 读取的8位无符号整数</span></span><br><span class="line">        frame.getLocalVars().setDouble(index, frame.getOpStack().popDouble());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其余指令实现都差不多，基本是和加载指令反过来而已。</p>
<h3 id="3-5-操作数栈（stack）指令"><a href="#3-5-操作数栈（stack）指令" class="headerlink" title="3.5 操作数栈（stack）指令"></a>3.5 操作数栈（stack）指令</h3><p>操作数栈指令，是直接对操作数栈中的数据进行操作。</p>
<p>共9条，包括：</p>
<ul>
<li>弹出指令：pop 系列指令将栈顶变量弹出</li>
<li>复制指令：dup 系列指令复制栈顶变量</li>
<li>交换指令：swap 指令交换栈顶的两个变量</li>
</ul>
<p>操作数栈指令，直接操作的是插槽 Slot，所以并不关系里面数据的类型。</p>
<p>因为只操作 Slot，所以需要给 OperandStack 增加2个操作 Slot 的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OperandStack</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pushSlot</span><span class="params">(Slot slot)</span> &#123;</span><br><span class="line">        slots[size].setSlot(slot);</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Slot <span class="title function_">popSlot</span><span class="params">()</span> &#123;</span><br><span class="line">        size--;</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot</span> <span class="operator">=</span> slots[size];</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">copySlot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Slot</span>(slot);</span><br><span class="line">        slot.setSlot(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> copySlot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的弹出 Slot 和推入 Slot，实际上并不是直接替换 Slot 对象，而是改变了它里面的值。</p>
<p>这是为了保证 Slot 对象一直存在，用于占位，避免空指针异常。</p>
<h4 id="3-5-1-弹出指令"><a href="#3-5-1-弹出指令" class="headerlink" title="3.5.1 弹出指令"></a>3.5.1 弹出指令</h4><p>弹出指令包括 <code>pop</code> 和 <code>pop2</code>。</p>
<p><code>pop</code> 指令用于弹出 <code>int</code>、<code>float</code> 等占用1个插槽位置的变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pop</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().popSlot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pop2</code> 指令用于弹出 <code>long</code>、<code>double</code> 等占用2个插槽位置的变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pop2</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().popSlot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="3-5-2-复制指令"><a href="#3-5-2-复制指令" class="headerlink" title="3.5.2 复制指令"></a>3.5.2 复制指令</h4><p>复制指令，用于复制操作数栈的变量。</p>
<p><code>dup</code> 指令是复制栈顶的单个变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dup</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot);</span><br><span class="line">        frame.getOpStack().pushSlot(slot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dup2</code> 指令是复制栈顶的2个变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dup2</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot1</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot2</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dupx1</code> 指令是复制栈顶的单个变量，但复制变量不是推入栈顶，具体看实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DupX1</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot1</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot2</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dupx2</code> 指令是复制栈顶的单个变量，但复制变量不是推入栈顶，具体看实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DupX2</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot1</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot2</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot3</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot3);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dup2x1</code> 指令是复制栈顶的2个变量，但复制变量不是推入栈顶，具体看实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dup2X1</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot1</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot2</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot3</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot3);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dup2x2</code> 指令是复制栈顶的2个变量，但复制变量不是推入栈顶，具体看实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dup2X2</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot1</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot2</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot3</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot4</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot4);</span><br><span class="line">        frame.getOpStack().pushSlot(slot3);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了 <code>dup</code>、<code>dup2</code>，其他几个指令还是挺麻烦的。</p>
<h4 id="3-5-3-交换指令"><a href="#3-5-3-交换指令" class="headerlink" title="3.5.3 交换指令"></a>3.5.3 交换指令</h4><p>交换指令，负责交换操作数栈的2个变量。</p>
<p>只有1条指令 <code>swap</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Swap</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot1</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        <span class="type">Slot</span> <span class="variable">slot2</span> <span class="operator">=</span> frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-6-数学（math）指令"><a href="#3-6-数学（math）指令" class="headerlink" title="3.6 数学（math）指令"></a>3.6 数学（math）指令</h3><p>数学指令，包括算术（加、减、乘、除）、位移、布尔、自增等基本指令。</p>
<p>共 37 条。</p>
<p>数学指令，都是先从操作数栈中弹出变量，执行数学运算后，再把结果推回操作数栈。</p>
<p>这里给几个例子：</p>
<p>算术指令，整数加法指令 <code>idd</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IAdd</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val1</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val2</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> val2 + val1;</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>算术指令，<code>double</code> 类型减法指令 <code>dsub</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DSub</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">val1</span> <span class="operator">=</span> frame.getOpStack().popDouble();</span><br><span class="line">        <span class="type">double</span> <span class="variable">val2</span> <span class="operator">=</span> frame.getOpStack().popDouble();</span><br><span class="line">        <span class="type">double</span> <span class="variable">val</span> <span class="operator">=</span> val2 - val1;</span><br><span class="line">        frame.getOpStack().pushDouble(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>位移指令，<code>int</code> 整型左移指令 <code>ishl</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IShl</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val1</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val2</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> val2 &lt;&lt; (val1 &amp; <span class="number">0x1f</span>);</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>位移指令，<code>long</code> 长整型无符号右移指令 <code>lushr</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LUShr</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="comment">// 注意位移操作数是一个int类型的</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">val1</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">long</span> <span class="variable">val2</span> <span class="operator">=</span> frame.getOpStack().popLong();</span><br><span class="line">        <span class="type">long</span> <span class="variable">val</span> <span class="operator">=</span> val2 &gt;&gt;&gt; (val1 &amp; <span class="number">0x3f</span>);</span><br><span class="line">        frame.getOpStack().pushLong(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>布尔指令，<code>int</code> 整型按位或指令 <code>or</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOr</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val1</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val2</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> val2 | val1;</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自增指令 <code>iinc</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IInc</span> <span class="keyword">implements</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 局部变量索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint8 index;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 常量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> frame.getLocalVars().getInt(index.value());</span><br><span class="line">        val += value;</span><br><span class="line">        frame.getLocalVars().setInt(index.value(), val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        index = reader.readUint8();</span><br><span class="line">        <span class="comment">// 注意这是一个8位的有符号整数</span></span><br><span class="line">        value = reader.readInt8();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数学指令还是比较简单的，不过像自增指令 <code>iinc</code> 就需要特别注意操作数类型。</p>
<h3 id="3-7-转换（conversions）指令"><a href="#3-7-转换（conversions）指令" class="headerlink" title="3.7 转换（conversions）指令"></a>3.7 转换（conversions）指令</h3><p>转换指令，是指对类型进行强制转换，比如 <code>double</code> 转 <code>long</code>，<code>float</code> 转 <code>int</code> 等。</p>
<p>共15条，这里暂时实现基本类型的转换。</p>
<p>引用类型的强制转换，会走 <code>checkcast</code> 指令，这里还没有办法实现。</p>
<p>这里给出几个例子：</p>
<p><code>i2x</code> 系列指令，<code>i2l</code> 是 <code>int</code> 转 <code>long</code> 类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">I2L</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        frame.getOpStack().pushLong(l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>l2x</code> 系列指令，<code>l2d</code> 是 <code>long</code> 转 <code>double</code> 类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">L2D</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> frame.getOpStack().popLong();</span><br><span class="line">        <span class="type">double</span> <span class="variable">d</span> <span class="operator">=</span> (<span class="type">double</span>) l;</span><br><span class="line">        frame.getOpStack().pushDouble(d);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>f2x</code> 系列指令，<code>f2i</code> 是 <code>float</code> 转 <code>int</code> 类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">F2I</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">f</span> <span class="operator">=</span> frame.getOpStack().popFloat();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (<span class="type">int</span>) f;</span><br><span class="line">        frame.getOpStack().pushInt(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换类型没什么特别的，都比较简单。</p>
<h3 id="3-8-比较（comparisons）指令"><a href="#3-8-比较（comparisons）指令" class="headerlink" title="3.8 比较（comparisons）指令"></a>3.8 比较（comparisons）指令</h3><p>比较指令，是比较变量的值，然后做出指定的操作。</p>
<p>共 19 条。</p>
<p>比较指令可分为2类：</p>
<ul>
<li>比较后，结果推入操作数栈顶</li>
<li>比较后，根据结果跳转</li>
</ul>
<p>比较指令主要用于实现 <code>if-else</code>、<code>for</code>、<code>while</code> 等语句。</p>
<h4 id="3-8-1-结果推入操作数栈"><a href="#3-8-1-结果推入操作数栈" class="headerlink" title="3.8.1 结果推入操作数栈"></a>3.8.1 结果推入操作数栈</h4><p>比较返回结果的指令有5条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lcmp</span><br><span class="line">fcmpg</span><br><span class="line">fcmpl</span><br><span class="line">dcmpg</span><br><span class="line">dcmpl</span><br></pre></td></tr></table></figure>

<p><code>lcmp</code> 指令用于比较 <code>long</code> 变量，并将结果（<code>int</code> 类型的-1/0/1）推入操作数栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LCmp</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">v2</span> <span class="operator">=</span> frame.getOpStack().popLong();</span><br><span class="line">        <span class="type">long</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popLong();</span><br><span class="line">        <span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> CmpUtil.cmpLong(v1, v2);</span><br><span class="line">        frame.getOpStack().pushInt(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于浮点数计算有可能产生 <code>NaN</code>（Not a Number）值，所以比较两个浮点数时，除了大于、等于、小于之外，还有第4种结果：无法比较。</p>
<p><code>fcmpg</code> 和 <code>fcmpl</code> 指令都是用于比较 float 变量，意义都差不多。</p>
<p><code>fcmpg</code> 和 <code>fcmpl</code> 指令的区别就在于对第4种结果（无法比较）的定义。</p>
<p>两个 · 变量中至少有一个是 <code>NaN</code> 时，用 <code>fcmpg</code> 指令比较的结果是1，而用 <code>fcmpl</code> 指令比较的结果是-1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FCmpg</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">v2</span> <span class="operator">=</span> frame.getOpStack().popFloat();</span><br><span class="line">        <span class="type">float</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popFloat();</span><br><span class="line">        <span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> CmpUtil.cmpFloat(v1, v2, <span class="literal">true</span>);</span><br><span class="line">        frame.getOpStack().pushInt(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FCmpl</span> <span class="keyword">extends</span> <span class="title class_">NoOperandsInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">v2</span> <span class="operator">=</span> frame.getOpStack().popFloat();</span><br><span class="line">        <span class="type">float</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popFloat();</span><br><span class="line">        <span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> CmpUtil.cmpFloat(v1, v2, <span class="literal">false</span>);</span><br><span class="line">        frame.getOpStack().pushInt(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面几个命令有用到的工具类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CmpUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">cmpLong</span><span class="params">(<span class="type">long</span> v1, <span class="type">long</span> v2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.compare(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">cmpFloat</span><span class="params">(<span class="type">float</span> v1, <span class="type">float</span> v2, <span class="type">boolean</span> gFlag)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (v1 &gt; v2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v1 == v2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v1 &lt; v2) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gFlag) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dcmpg</code> 和 <code>dcmpl</code> 指令用来比较 <code>double</code> 变量，它们的意义和 <code>fcmpg</code>、<code>fcmpl</code> 指令一样，这里不再给出。</p>
<h4 id="3-8-2-比较跳转"><a href="#3-8-2-比较跳转" class="headerlink" title="3.8.2 比较跳转"></a>3.8.2 比较跳转</h4><p>比较跳转的指令有14条，可以分为2类：</p>
<ul>
<li>单操作数指令：<code>if&lt;cond&gt;</code> 指令</li>
<li>双操作数指令：<code>if_icmp&lt;cond&gt;</code> 和 <code>if_acmp&lt;cond&gt;</code> 指令</li>
</ul>
<p>单操作数 <code>if&lt;cond&gt;</code> 指令，是从栈顶弹出一个 <code>int</code> 整型变量和 0 进行比较：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ifeq: x == 0</span><br><span class="line">ifne: x != 0</span><br><span class="line">iflt: x &lt; 0</span><br><span class="line">ifle: x &lt;= 0</span><br><span class="line">ifgt: x &gt; 0</span><br><span class="line">ifge: x &gt;= 0</span><br></pre></td></tr></table></figure>

<p>实现很简单，<code>ifeq</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IfEq</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (v1 == <span class="number">0</span>) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ifle</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IfLe</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (v1 &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他指令类似，不在举例。</p>
<p>双操作数指令 <code>if_icmp&lt;cond&gt;</code>，用于从栈顶弹出2个 <code>int</code> 整型变量进行比较，然后跳转：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if_icmpeq: if x1 == x2</span><br><span class="line">if_icmpne: if x1 != x2</span><br><span class="line">if_icmplt: if x1 &lt; x2</span><br><span class="line">if_icmple: if x1 &lt;= x2</span><br><span class="line">if_icmpgt: if x1 &gt; x2</span><br><span class="line">if_icmpge: if x1 &gt;= x2</span><br></pre></td></tr></table></figure>

<p><code>if_icmpne</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IfICmpNe</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v2</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (v1 != v2) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>if_icmpgt</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IfICmpGt</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v2</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (v1 &gt; v2) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>双操作数指令 <code>if_acmp&lt;cond&gt;</code>，也是从栈顶弹出2个变量，不过是引用变量，引用变量的比较只有2种情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if_acmpeq: if x1 == x2</span><br><span class="line">if_acmpne: if x1 != x2</span><br></pre></td></tr></table></figure>

<p><code>if_acmpeq</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IfACmpEq</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v2</span> <span class="operator">=</span> frame.getOpStack().popRef();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popRef();</span><br><span class="line">        <span class="keyword">if</span> (v1 == v2) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>if_acmpne</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IfACmpNe</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v2</span> <span class="operator">=</span> frame.getOpStack().popRef();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popRef();</span><br><span class="line">        <span class="keyword">if</span> (v1 != v2) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-9-控制（control）指令"><a href="#3-9-控制（control）指令" class="headerlink" title="3.9 控制（control）指令"></a>3.9 控制（control）指令</h3><p>控制指令，主要用于地址的直接跳转。</p>
<p>比如 <code>return</code>、<code>goto</code>、<code>switch</code> 等语句的实现。</p>
<p>包括的指令有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">goto</span><br><span class="line">tableswitch</span><br><span class="line">lookupswitch</span><br><span class="line">ireturn</span><br><span class="line">lreturn</span><br><span class="line">freturn</span><br><span class="line">dreturn</span><br><span class="line">areturn</span><br></pre></td></tr></table></figure>

<p><code>return</code> 系列指令等后面再实现。</p>
<p><code>goto</code> 指令进行无条件跳转：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Goto</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        branch(frame);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tableswitch</code> 指令和 <code>lookupswitch</code> 指令都是用于实现 <code>switch</code> 语句的：</p>
<ul>
<li><code>tableswitch</code> 指令：<code>case</code> 值可以编码成一个索引表</li>
<li><code>lookupswitch</code> 指令：<code>case</code> 值不可以编码成一个索引表</li>
</ul>
<p>什么时候 <code>case</code> 值可以编码成一个索引表？比如下面这2个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (i) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:  <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:  <span class="keyword">return</span>  <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:  <span class="keyword">return</span>  <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种 <code>case</code> 值是大于等于 0 的值，可以作为索引，就会编译成 <code>tableswitch</code> 指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (i) &#123;</span><br><span class="line">    <span class="keyword">case</span> -<span class="number">100</span>: <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:    <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:  <span class="keyword">return</span>  <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">default</span>:   <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种存在负数的值，就不能用作索引，就会编译成 <code>lookupswitch</code> 指令。</p>
<p><code>tableswitch</code> 指令的实现是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TableSwitch</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> defaultOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> low;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> high;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] jumpOffsets;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= low &amp;&amp; index &lt;= high) &#123;</span><br><span class="line">            offset = jumpOffsets[index - low];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            offset = defaultOffset;</span><br><span class="line">        &#125;</span><br><span class="line">        branch(frame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        reader.skipPadding();</span><br><span class="line">        defaultOffset = reader.readInt();</span><br><span class="line">        low = reader.readInt();</span><br><span class="line">        high = reader.readInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">jumpOffsetsCount</span> <span class="operator">=</span> high - low + <span class="number">1</span>;</span><br><span class="line">        jumpOffsets = reader.readInts(jumpOffsetsCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>defaultOffset</code> 就是 <code>switch</code> 语句中的 <code>default</code> 语句，而 <code>low</code> 和 <code>high</code> 则是对应的 <code>case</code> 语句的范围。</p>
<p><code>jumpOffsets</code> 是一个索引表，里面存放 <code>high - low + 1</code> 个 <code>int</code> 值，对应各种 <code>case</code> 情况下，执行跳转所需的字节码偏移量。</p>
<p><code>tableswitch</code> 指令的操作数是从栈中弹出的，作为偏移量地址，如果在 <code>low</code> 和 <code>high</code> 范围内，则说明是 <code>case</code> 语句，否则是 <code>default</code> 语句。</p>
<p><code>tableswitch</code> 指令操作码的后面有 0~3 字节的 <code>padding</code>，这个是为了对齐地址用的，保证 <code>defaultOffset</code> 在字节码中的地址是4的倍数。</p>
<p>下面是 <code>lookupswitch</code> 指令的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LookupSwitch</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> defaultOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> npairs;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] matchOffsets;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> frame.getOpStack().popInt();</span><br><span class="line">        offset = defaultOffset;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; npairs * <span class="number">2</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matchOffsets[i] == key) &#123;</span><br><span class="line">                offset = matchOffsets[i + <span class="number">1</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        branch(frame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        reader.skipPadding();</span><br><span class="line">        defaultOffset = reader.readInt();</span><br><span class="line">        npairs = reader.readInt();</span><br><span class="line">        matchOffsets = reader.readInts(npairs * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>defaultOffset</code> 也是默认的地址偏移量，<code>npairs</code> 表示有多少个 <code>case</code> 语句。</p>
<p>每个 <code>case</code> 语句都包括2部分内容：一个就是 <code>case</code> 的 key 值，比如前面的 100，一个是 <code>case</code> 代码的地址偏移量，表示跳转的偏移地址。</p>
<p><code>lookupswitch</code> 指令的操作数也是从栈中弹出，作为 <code>case</code> 的 <code>key</code> 去比较，找到则跳转到 <code>case</code> 对应的偏移地址，否则跳到 <code>default</code> 语句。</p>
<p><code>lookupswitch</code> 指令也有地址对齐的操作，和 <code>tableswitch</code> 指令作用一样。</p>
<h3 id="3-10-引用（references）指令"><a href="#3-10-引用（references）指令" class="headerlink" title="3.10 引用（references）指令"></a>3.10 引用（references）指令</h3><p>引用指令，是和字段访问、方法调用相关的指令。</p>
<p>这里暂不实现。</p>
<h3 id="3-11-扩展（extended）指令"><a href="#3-11-扩展（extended）指令" class="headerlink" title="3.11 扩展（extended）指令"></a>3.11 扩展（extended）指令</h3><p>扩展指令，是给一些操作数比较小的指令进行扩展。</p>
<p>扩展指令有3类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wide</span><br><span class="line">ifnull 和 ifnonnull</span><br><span class="line">goto_w</span><br></pre></td></tr></table></figure>

<h4 id="3-11-1-wide"><a href="#3-11-1-wide" class="headerlink" title="3.11.1 wide"></a>3.11.1 wide</h4><p><code>wide</code> 指令用于扩展操作索引的范围。</p>
<p>比如加载指令、存储指令等需要访问局部变量表的指令，索引用的都是 uint8 字节。</p>
<p>对于大部分方法来说，uint8 的大小已经足够满足了，但是不排除有些方法的局部变量表过大，所以才使用 <code>wide</code> 执行来扩展它们。</p>
<p>扩展的指令包括：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0x15: iload</span><br><span class="line">0x16: lload</span><br><span class="line">0x17: fload</span><br><span class="line">0x18: dload</span><br><span class="line">0x19: aload</span><br><span class="line">0x36: istore</span><br><span class="line">0x37: lstore</span><br><span class="line">0x38: fstore</span><br><span class="line">0x39: dstore</span><br><span class="line">0x3a: astore</span><br><span class="line">0x84: iinc</span><br><span class="line">0xa9: ret</span><br></pre></td></tr></table></figure>

<p><code>wide</code> 指令只是增加了索引宽度，并不改变子指令操作。</p>
<p>比如，原来的加载指令 <code>iload</code> 操作数是一个 uint8 字节的索引，在 <code>wide</code> 指令中则是 uint16 的双字节索引：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WILoad</span> <span class="keyword">extends</span> <span class="title class_">Index16Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getOpStack().pushInt(frame.getLocalVars().getInt(index));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这里换成了 <code>Index16Instruction</code> 基类，使用的是2字节的索引。</p>
<p>同理，<code>dstore</code> 指令也换成了双操作数索引：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WDStore</span> <span class="keyword">extends</span> <span class="title class_">Index16Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        frame.getLocalVars().setDouble(index, frame.getOpStack().popDouble());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自增指令 <code>iinc</code> 也是一样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WIInc</span> <span class="keyword">implements</span> <span class="title class_">Instruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 局部变量索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 index;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 常量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> frame.getLocalVars().getInt(index.value());</span><br><span class="line">        val += value;</span><br><span class="line">        frame.getLocalVars().setInt(index.value(), val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        index = reader.readUint16();</span><br><span class="line">        <span class="comment">// 注意这里是16位有符号整数</span></span><br><span class="line">        value = reader.readInt16();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他指令类似，不再列出。</p>
<h4 id="3-11-2-ifnull-和-ifnonnul"><a href="#3-11-2-ifnull-和-ifnonnul" class="headerlink" title="3.11.2 ifnull 和 ifnonnul"></a>3.11.2 ifnull 和 ifnonnul</h4><p>和前面的比较指令差不多，<code>ifnull</code> 和 <code>ifnonnull</code> 就是用于比较 <code>null</code> 值并跳转的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IfNull</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popRef();</span><br><span class="line">        <span class="keyword">if</span> (v1 == <span class="literal">null</span>) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IfNonNull</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> frame.getOpStack().popRef();</span><br><span class="line">        <span class="keyword">if</span> (v1 != <span class="literal">null</span>) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-11-3-goto-w"><a href="#3-11-3-goto-w" class="headerlink" title="3.11.3 goto_w"></a>3.11.3 goto_w</h4><p>前面的 <code>goto</code> 指令操作数是 int16 位有符号整数，<code>goto_w</code> 指令则是扩展成 int32 位有符号整数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WGoto</span> <span class="keyword">extends</span> <span class="title class_">BranchInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">        branch(frame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> &#123;</span><br><span class="line">        <span class="comment">// 注意是32位有符号整数</span></span><br><span class="line">        offset = reader.readInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-12-保留（reserved）指令"><a href="#3-12-保留（reserved）指令" class="headerlink" title="3.12 保留（reserved）指令"></a>3.12 保留（reserved）指令</h3><p>保留指令是留给虚拟机用的，这里暂时不实现。</p>
<h2 id="四、解释器"><a href="#四、解释器" class="headerlink" title="四、解释器"></a>四、解释器</h2><p>完成所有指令的解析之后，就可以实现一个简单的解释器，执行解析好的指令。</p>
<p>因为方法的调用，最后都会执行 <code>return</code> 语句，由于暂时未实现 <code>return</code> 语句，所以解释器目前只能执行一个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Interpreter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">interpret</span><span class="params">(MethodInfo methodInfo)</span> &#123;</span><br><span class="line">        <span class="comment">// 拿到方法的代码属性</span></span><br><span class="line">        <span class="type">CodeAttributeInfo</span> <span class="variable">codeAttr</span> <span class="operator">=</span> methodInfo.getCodeAttributeInfo();</span><br><span class="line">        <span class="type">Uint16</span> <span class="variable">maxLocals</span> <span class="operator">=</span> codeAttr.getMaxLocals();</span><br><span class="line">        <span class="type">Uint16</span> <span class="variable">maxStack</span> <span class="operator">=</span> codeAttr.getMaxStack();</span><br><span class="line">        <span class="type">byte</span>[] codes = codeAttr.getCodes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个栈帧测试</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>();</span><br><span class="line">        <span class="type">Frame</span> <span class="variable">frame</span> <span class="operator">=</span> thread.newFrame(maxLocals.value(), maxStack.value());</span><br><span class="line">        thread.pushFrame(frame);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解释执行代码</span></span><br><span class="line">        loop(thread, codes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">(Thread thread, <span class="type">byte</span>[] codes)</span> &#123;</span><br><span class="line">        <span class="type">Frame</span> <span class="variable">frame</span> <span class="operator">=</span> thread.popFrame();</span><br><span class="line">        <span class="type">ByteCodeReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteCodeReader</span>(codes);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 程序计数器地址</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">pc</span> <span class="operator">=</span> frame.getNextPc();</span><br><span class="line">                thread.setPc(pc);</span><br><span class="line">                reader.setPosition(pc);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 编译识别指令</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">opcode</span> <span class="operator">=</span> reader.readUint8().value();</span><br><span class="line">                <span class="type">Instruction</span> <span class="variable">instruction</span> <span class="operator">=</span> InstructionFactory.newInstance(opcode);</span><br><span class="line">                <span class="keyword">if</span> (instruction == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取指定操作数</span></span><br><span class="line">                instruction.fetchOperands(reader);</span><br><span class="line">                frame.setNextPc(reader.getPosition());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 执行指令</span></span><br><span class="line">                instruction.execute(frame);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Frame: &quot;</span> + frame);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释器的逻辑很简单：</p>
<ol>
<li>从指定方法中拿出 <code>code</code> 代码属性</li>
<li>根据指令集解析 <code>code</code> 代码的指令</li>
<li>执行解析好的指令</li>
</ol>
<p>由于没有实现 <code>return</code> 指令，所以不能很好的看出结果，而且执行到最后肯定会报错。</p>
<p>这里通过捕获错误，并打印栈帧来查看结果。</p>
<p><code>getCodeAttributeInfo()</code>、<code>getMaxLocals()</code> 这些都是 <code>MethodInfo</code> 新增的 <code>get</code> 方法，这里不多说。</p>
<p><code>InstructionFactory.newInstance(opcode)</code> 是根据字节码生成对应的指令，实现差不多这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstructionFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Instruction <span class="title function_">newInstance</span><span class="params">(<span class="type">int</span> opcode)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x00</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Nop</span>();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x01</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AConstNull</span>();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x02</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IConstM1</span>();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x03</span>:</span><br><span class="line">                .</span><br><span class="line">                .</span><br><span class="line">                .</span><br><span class="line">               ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>太长了，这里就不全列举出来了。</p>
<p>还需要改造一下 Jvm 类的代码，让他可以跑指定的方法，这里执行的是 main 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Jvm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Cmd</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cmd</span>();</span><br><span class="line">        cmd.printHelp();</span><br><span class="line"></span><br><span class="line">        String[] testArgs = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123; <span class="string">&quot;com.wjd.cmd.Cmd&quot;</span>, <span class="string">&quot;-classpath&quot;</span>,</span><br><span class="line">                <span class="string">&quot;D:\\Projects\\IdeaProjects\\self-jvm\\target\\test-classes;D:\\Projects\\IdeaProjects\\self-jvm\\target\\classes&quot;</span> &#125;;</span><br><span class="line">        cmd.parse(testArgs);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">userClassName</span> <span class="operator">=</span> <span class="string">&quot;com\\wjd\\instructions\\InstructionsTest&quot;</span>;</span><br><span class="line">        <span class="type">Classpath</span> <span class="variable">classpath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Classpath</span>(cmd.getJreOption(), cmd.getCpOption());</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassFile</span> <span class="variable">classFile</span> <span class="operator">=</span> loadClass(userClassName, classpath);</span><br><span class="line">        <span class="type">MethodInfo</span> <span class="variable">mainMethod</span> <span class="operator">=</span> getMainMethod(classFile);</span><br><span class="line">        <span class="keyword">if</span> (mainMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 解释器执行，解释执行 main 方法</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Interpreter</span>().interpret(mainMethod);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Not found main method!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ClassFile <span class="title function_">loadClass</span><span class="params">(String className, Classpath classpath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] userClassBytes = classpath.readClass(className);</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(userClassBytes);</span><br><span class="line">        <span class="keyword">return</span> ClassFile.parse(reader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取类文件中的main方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MethodInfo <span class="title function_">getMainMethod</span><span class="params">(ClassFile classFile)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (MethodInfo m : classFile.getMethods())</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;main&quot;</span>.equals(m.name()) &amp;&amp; <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>.equals(m.descriptor())) &#123;</span><br><span class="line">                <span class="keyword">return</span> m;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改的内容就是找到测试类，拿出它的 main 方法，然后交给解释器 <code>Interpreter</code> 去解释执行。</p>
<h2 id="五、单元测试"><a href="#五、单元测试" class="headerlink" title="五、单元测试"></a>五、单元测试</h2><p>测试类，就是要测试执行它的 main 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstructionsTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            sum += i;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试应该会出现错误，在异常捕获里面，栈帧输出结果里面应该包含结果值 <code>5050</code>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="指令结构"><a href="#指令结构" class="headerlink" title="指令结构"></a>指令结构</h3><ul>
<li>字节码中存放编码后的 Java 虚拟机指令，每条指令都以一个单字节的操作码（opcode）开头</li>
<li>由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令</li>
<li>Java 虚拟机使用的是变长指令，操作码后面可以跟零字节或多字节的操作数（operand）</li>
<li>比如 <code>0xB20002</code> 这条指令，<code>B2</code> 表示该指令的操作码，<code>0002</code> 就表示操作数</li>
</ul>
<h3 id="指令助记符"><a href="#指令助记符" class="headerlink" title="指令助记符"></a>指令助记符</h3><ul>
<li>为了便于记忆，Java 虚拟机规范给每个操作码都指定了一个助记符（mnemonic）</li>
<li>比如，操作码是 <code>0x00</code> 的助记符是 nop（no operation）</li>
<li>操作数栈和局部变量表只存放数据的值（Slot），并不记录数据类型</li>
<li>指令必须知道自己在操作什么类型的数据，即指令绑定了数据类型</li>
<li>例如，<code>iadd</code> 指令就是对 <code>int</code> 值进行加法操作</li>
</ul>
<h3 id="指令类型"><a href="#指令类型" class="headerlink" title="指令类型"></a>指令类型</h3><p>Java 虚拟机规范把已经定义的205条指令按用途分成了11类，分别是：</p>
<ul>
<li>常量（constants）指令</li>
<li>加载（loads）指令</li>
<li>存储（stores）指令</li>
<li>操作数栈（stack）指令</li>
<li>数学（math）指令</li>
<li>转换（conversions）指令</li>
<li>比较（comparisons）指令</li>
<li>控制（control）指令</li>
<li>引用（references）指令</li>
<li>扩展（extended）指令</li>
<li>保留（reserved）指令</li>
</ul>
<p>保留指令：</p>
<ul>
<li>1条是留给调试器的，用于实现断点，操作码是 <code>202(0xCA)</code>，助记符是 <code>breakpoint</code></li>
<li>另外2条留给 Java 虚拟机实现内部使用，操作码分别是 <code>254(0xFE)</code> 和 <code>266(0xFF)</code>，助记符是 <code>impdep1</code> 和 <code>impdep2</code></li>
</ul>
</div><div class="level is-mobile is-flex"><div class="article-licensing box"><div class="licensing-title"><p>05_指令集和解释器</p><p><a href="http://example.com/lang/java/jvm/selfjvm/05_instruction/">http://example.com/lang/java/jvm/selfjvm/05_instruction/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>jiaduo</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-02-21</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-04-03</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/java/">java, </a><a class="link-muted" rel="tag" href="/tags/JVM/">JVM </a></div><!--!--></div></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/lang/java/core/concurrency/02_%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">02_线程安全性</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/design_pattern/mediator/"><span class="level-item">中介者模式</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#指令集和解释器"><span class="level-left"><span class="level-item">指令集和解释器</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#一、字节码指令"><span class="level-left"><span class="level-item">一、字节码指令</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-指令结构"><span class="level-left"><span class="level-item">1.1 指令结构</span></span></a></li><li><a class="level is-mobile" href="#1-2-指令助记符"><span class="level-left"><span class="level-item">1.2 指令助记符</span></span></a></li><li><a class="level is-mobile" href="#1-3-指令类型"><span class="level-left"><span class="level-item">1.3 指令类型</span></span></a></li></ul></li><li><a class="level is-mobile" href="#二、指令运行"><span class="level-left"><span class="level-item">二、指令运行</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-指令循环"><span class="level-left"><span class="level-item">2.1 指令循环</span></span></a></li><li><a class="level is-mobile" href="#2-2-指令接口"><span class="level-left"><span class="level-item">2.2 指令接口</span></span></a></li><li><a class="level is-mobile" href="#2-2-指令解码"><span class="level-left"><span class="level-item">2.2 指令解码</span></span></a></li></ul></li><li><a class="level is-mobile" href="#三、指令集"><span class="level-left"><span class="level-item">三、指令集</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-抽象指令基类"><span class="level-left"><span class="level-item">3.1 抽象指令基类</span></span></a></li><li><a class="level is-mobile" href="#3-2-常量（constants）指令"><span class="level-left"><span class="level-item">3.2 常量（constants）指令</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-2-1-隐含在操作码的常量"><span class="level-left"><span class="level-item">3.2.1 隐含在操作码的常量</span></span></a></li><li><a class="level is-mobile" href="#3-2-2-操作数常量"><span class="level-left"><span class="level-item">3.2.2 操作数常量</span></span></a></li><li><a class="level is-mobile" href="#3-2-3-常量池常量"><span class="level-left"><span class="level-item">3.2.3 常量池常量</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-3-加载（loads）指令"><span class="level-left"><span class="level-item">3.3 加载（loads）指令</span></span></a></li><li><a class="level is-mobile" href="#3-4-存储（stores）指令"><span class="level-left"><span class="level-item">3.4 存储（stores）指令</span></span></a></li><li><a class="level is-mobile" href="#3-5-操作数栈（stack）指令"><span class="level-left"><span class="level-item">3.5 操作数栈（stack）指令</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-5-1-弹出指令"><span class="level-left"><span class="level-item">3.5.1 弹出指令</span></span></a></li><li><a class="level is-mobile" href="#3-5-2-复制指令"><span class="level-left"><span class="level-item">3.5.2 复制指令</span></span></a></li><li><a class="level is-mobile" href="#3-5-3-交换指令"><span class="level-left"><span class="level-item">3.5.3 交换指令</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-6-数学（math）指令"><span class="level-left"><span class="level-item">3.6 数学（math）指令</span></span></a></li><li><a class="level is-mobile" href="#3-7-转换（conversions）指令"><span class="level-left"><span class="level-item">3.7 转换（conversions）指令</span></span></a></li><li><a class="level is-mobile" href="#3-8-比较（comparisons）指令"><span class="level-left"><span class="level-item">3.8 比较（comparisons）指令</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-8-1-结果推入操作数栈"><span class="level-left"><span class="level-item">3.8.1 结果推入操作数栈</span></span></a></li><li><a class="level is-mobile" href="#3-8-2-比较跳转"><span class="level-left"><span class="level-item">3.8.2 比较跳转</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-9-控制（control）指令"><span class="level-left"><span class="level-item">3.9 控制（control）指令</span></span></a></li><li><a class="level is-mobile" href="#3-10-引用（references）指令"><span class="level-left"><span class="level-item">3.10 引用（references）指令</span></span></a></li><li><a class="level is-mobile" href="#3-11-扩展（extended）指令"><span class="level-left"><span class="level-item">3.11 扩展（extended）指令</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-11-1-wide"><span class="level-left"><span class="level-item">3.11.1 wide</span></span></a></li><li><a class="level is-mobile" href="#3-11-2-ifnull-和-ifnonnul"><span class="level-left"><span class="level-item">3.11.2 ifnull 和 ifnonnul</span></span></a></li><li><a class="level is-mobile" href="#3-11-3-goto-w"><span class="level-left"><span class="level-item">3.11.3 goto_w</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-12-保留（reserved）指令"><span class="level-left"><span class="level-item">3.12 保留（reserved）指令</span></span></a></li></ul></li><li><a class="level is-mobile" href="#四、解释器"><span class="level-left"><span class="level-item">四、解释器</span></span></a></li><li><a class="level is-mobile" href="#五、单元测试"><span class="level-left"><span class="level-item">五、单元测试</span></span></a></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">总结</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#指令结构"><span class="level-left"><span class="level-item">指令结构</span></span></a></li><li><a class="level is-mobile" href="#指令助记符"><span class="level-left"><span class="level-item">指令助记符</span></span></a></li><li><a class="level is-mobile" href="#指令类型"><span class="level-left"><span class="level-item">指令类型</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="追来者之人" height="28"></a><p class="is-size-7"><span>&copy; 2023 jiaduo</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>