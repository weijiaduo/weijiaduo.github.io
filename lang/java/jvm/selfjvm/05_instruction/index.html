<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="指令集和解释器Java虚拟机顾名思义，就是一台虚拟的机器，而字节码（bytecode）就是运行在这台虚拟机器上的机器码。 一、字节码指令1.1 指令结构字节码中存放编码后的 Java 虚拟机指令：  每条指令都以一个单字节的操作码（opcode）开头。  由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令。   到第八版为止，Java 虚拟机规范已经定义了205条指令，操作码">
<meta property="og:type" content="article">
<meta property="og:title" content="05_指令集和解释器">
<meta property="og:url" content="http://example.com/lang/java/jvm/selfjvm/05_instruction/index.html">
<meta property="og:site_name" content="Strive">
<meta property="og:description" content="指令集和解释器Java虚拟机顾名思义，就是一台虚拟的机器，而字节码（bytecode）就是运行在这台虚拟机器上的机器码。 一、字节码指令1.1 指令结构字节码中存放编码后的 Java 虚拟机指令：  每条指令都以一个单字节的操作码（opcode）开头。  由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令。   到第八版为止，Java 虚拟机规范已经定义了205条指令，操作码">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-02-20T16:13:21.000Z">
<meta property="article:modified_time" content="2022-02-20T16:05:17.644Z">
<meta property="article:author" content="jiaduo">
<meta property="article:tag" content="java">
<meta property="article:tag" content="JVM">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/lang/java/jvm/selfjvm/05_instruction/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>05_指令集和解释器 | Strive</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Strive</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Rome was not built in one day</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/lang/java/jvm/selfjvm/05_instruction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lufei.jpeg">
      <meta itemprop="name" content="jiaduo">
      <meta itemprop="description" content="不积跬步，无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Strive">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          05_指令集和解释器
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-02-21 00:13:21 / 修改时间：00:05:17" itemprop="dateCreated datePublished" datetime="2022-02-21T00:13:21+08:00">2022-02-21</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>26 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="指令集和解释器"><a href="#指令集和解释器" class="headerlink" title="指令集和解释器"></a>指令集和解释器</h1><p>Java虚拟机顾名思义，就是一台虚拟的机器，而字节码（bytecode）就是运行在这台虚拟机器上的机器码。</p>
<h2 id="一、字节码指令"><a href="#一、字节码指令" class="headerlink" title="一、字节码指令"></a>一、字节码指令</h2><h3 id="1-1-指令结构"><a href="#1-1-指令结构" class="headerlink" title="1.1 指令结构"></a>1.1 指令结构</h3><p>字节码中存放编码后的 Java 虚拟机指令：</p>
<ul>
<li><p>每条指令都以一个单字节的操作码（opcode）开头。</p>
</li>
<li><p>由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令。</p>
</li>
</ul>
<p>到第八版为止，Java 虚拟机规范已经定义了205条指令，操作码分别是<code>0(0x00)</code>到 <code>202(0xCA)</code>、<code>254(0xFE)</code>和 <code>255(0xFF)</code>。</p>
<span id="more"></span>

<ul>
<li>Java虚拟机使用的是变长指令，操作码后面可以跟零字节或多字节的操作数（operand）。</li>
</ul>
<p>比如 <code>0xB20002</code> 这条指令，<code>B2</code> 表示该指令的操作码，<code>0002</code> 就表示操作数。</p>
<h3 id="1-2-指令助记符"><a href="#1-2-指令助记符" class="headerlink" title="1.2 指令助记符"></a>1.2 指令助记符</h3><p>为了便于记忆，Java虚拟机规范给每个操作码都指定了一个助记符（mnemonic）。</p>
<p>比如，操作码是 <code>0x00</code> 的助记符是 <code>nop</code>（no operation）。</p>
<ul>
<li><p>操作数栈和局部变量表只存放数据的值（Slot），并不记录数据类型。</p>
</li>
<li><p>所以指令必须知道自己在操作什么类型的数据，即指令绑定了数据类型</p>
</li>
</ul>
<p>例如，<code>iadd</code> 指令就是对 int 值进行加法操作；<code>dstore</code> 指令把操作数栈顶的double值弹出，存储到局部变量表中；<code>areturn</code> 从方法中返回引用值。</p>
<h3 id="1-3-指令类型"><a href="#1-3-指令类型" class="headerlink" title="1.3 指令类型"></a>1.3 指令类型</h3><p>Java 虚拟机规范把已经定义的205条指令按用途分成了11类，分别是：</p>
<ul>
<li>常量（constants）指令</li>
<li>加载（loads）指令</li>
<li>存储（stores）指令</li>
<li>操作数栈（stack）指令</li>
<li>数学（math）指令</li>
<li>转换（conversions）指令</li>
<li>比较（comparisons）指令</li>
<li>控制（control）指令</li>
<li>引用（references）指令</li>
<li>扩展（extended）指令</li>
<li>保留（reserved）指令</li>
</ul>
<p>保留指令一共有3条。</p>
<ul>
<li><p>其中1条是留给调试器的，用于实现断点，操作码是 <code>202(0xCA)</code>，助记符是 <code>breakpoint</code>；</p>
</li>
<li><p>另外2条留给 Java 虚拟机实现内部使用，操作码分别是 <code>254(0xFE)</code> 和 <code>266(0xFF)</code>，助记符是 <code>impdep1</code> 和 <code>impdep2</code>。</p>
</li>
</ul>
<p>这3条保留指令不允许出现在class文件中。</p>
<h2 id="二、指令运行"><a href="#二、指令运行" class="headerlink" title="二、指令运行"></a>二、指令运行</h2><h3 id="2-1-指令循环"><a href="#2-1-指令循环" class="headerlink" title="2.1 指令循环"></a>2.1 指令循环</h3><p>虚拟机的运行过程，就是循环执行指令的过程，伪代码大致是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    atomically calculate pc and fetch opcode at pc;</span><br><span class="line">    <span class="keyword">if</span> (operands) fetch operands;</span><br><span class="line">    execute the action <span class="keyword">for</span> the opcode;</span><br><span class="line">&#125; <span class="keyword">while</span> (there is more to <span class="keyword">do</span>);</span><br></pre></td></tr></table></figure>

<p>每次循环都包含三个部分：</p>
<ol>
<li>计算pc</li>
<li>指令解码</li>
<li>指令执行</li>
</ol>
<p>上面的伪代码转成 java 代码的话，大概是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 计算PC</span></span><br><span class="line">    pc = calculatePC()</span><br><span class="line">    <span class="comment">// 指令解码</span></span><br><span class="line">    opcode = bytecode[pc]</span><br><span class="line">    inst = createInst(opcode)</span><br><span class="line">    inst.fetchOperands(bytecode)</span><br><span class="line">    <span class="comment">// 指令执行</span></span><br><span class="line">    inst.execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-指令接口"><a href="#2-2-指令接口" class="headerlink" title="2.2 指令接口"></a>2.2 指令接口</h3><p>根据上述的伪代码，创建指令接口 <code>Instruction</code>，作为所有指令实现的基本接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口包括2个方法：取数（<code>fetchOperands</code>）和执行（<code>execute</code>）。</p>
<h3 id="2-2-指令解码"><a href="#2-2-指令解码" class="headerlink" title="2.2 指令解码"></a>2.2 指令解码</h3><p>接下来就是怎么把字节码解析成指令接口了。</p>
<p>因为需要操作字节，所以定义字节码读取类 <code>ByteCodeReader</code>，用于读取字节码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteCodeReader</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 字节码字节数组 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] bytes;</span><br><span class="line">    <span class="comment">/** 字节缓冲读取 */</span></span><br><span class="line">    <span class="keyword">private</span> ByteBuffer buf;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteCodeReader</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        reset(bytes, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">(<span class="keyword">byte</span>[] bytes, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bytes = bytes;</span><br><span class="line">        buf = ByteBuffer.wrap(bytes);</span><br><span class="line">        buf.order(ByteOrder.BIG_ENDIAN); <span class="comment">// 大端</span></span><br><span class="line">        buf.position(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPosition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> buf.position();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span> <span class="title">readByte</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> buf.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readShort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> buf.getShort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readInt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> buf.getInt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readInt8</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> readByte();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uint8 <span class="title">readUint8</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span> b = buf.get();</span><br><span class="line">        <span class="keyword">int</span> val = <span class="number">0x0FF</span> &amp; b;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Uint8(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readInt16</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> readShort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uint16 <span class="title">readUint16</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">short</span> s = buf.getShort();</span><br><span class="line">        <span class="keyword">int</span> val = <span class="number">0x0FFFF</span> &amp; s;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Uint16(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uint32 <span class="title">readUint32</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = buf.getInt();</span><br><span class="line">        <span class="keyword">long</span> val = <span class="number">0x0FFFFFFFFL</span> &amp; i;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Uint32(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] readBytes(Uint32 length) &#123;</span><br><span class="line">        <span class="keyword">int</span> len = (<span class="keyword">int</span>) length.value();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">        buf.get(bytes);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">skipPadding</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (getPosition() % <span class="number">4</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            readUint8();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>bytes</code> 存放原始的字节码字节数组，<code>buf</code> 是 java 中的 <code>ByteBuffer</code> 类对象，可以对字节进行操作。</p>
<p>因为有些数据是占用不止1个机器字的，所以需要定义字节数组是大端，还是小端，这里设定是大端。</p>
<p><code>getPosition()</code> 可用于获取当前读到的位置，这个主要是用于后面程序计数器 PC 的定位。</p>
<p>剩余的则是读取不同数据格式的方法，和 classfile 的读取差不多。</p>
<h2 id="三、指令集"><a href="#三、指令集" class="headerlink" title="三、指令集"></a>三、指令集</h2><h3 id="3-1-抽象指令基类"><a href="#3-1-抽象指令基类" class="headerlink" title="3.1 抽象指令基类"></a>3.1 抽象指令基类</h3><p>接口包括2个方法：取数（<code>fetchOperands</code>）和执行（<code>execute</code>）。</p>
<p>很多指令都具有相同的操作数类型，所以定义一些基类来方便实现。</p>
<p>有些指令是没有操作数的，定义一个无操作数基类 <code>NoOperandsInstruction</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoOperandsInstruction</span> <span class="keyword">implements</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 什么也不做</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 什么也不做</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有些指令需要访问局部变量表，局部变量表索引是一个8位无符号整数，定义一个基类 <code>Index8Instruction</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Index8Instruction</span> <span class="keyword">implements</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">protected</span> Uint8 source;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        source = reader.readUint8();</span><br><span class="line">        index = source.value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有些指令需要访问常量池，常量池索引是一个16位无符号整数，定义一个基类 <code>Index16Instruction</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Index16Instruction</span> <span class="keyword">implements</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">protected</span> Uint16 source;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        source = reader.readUint16();</span><br><span class="line">        index = source.value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有跳转指令，它的操作数是16位无符号整数，定义基类 <code>BranchInstruction</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BranchInstruction</span> <span class="keyword">implements</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 16位有符号整数偏移 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> offset;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注意是16位有符号整数</span></span><br><span class="line">        offset = reader.readShort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指令跳转</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> frame 栈帧</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">branch</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> pc = frame.getThread().getPc();</span><br><span class="line">        frame.setNextPc(pc + offset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-常量（constants）指令"><a href="#3-2-常量（constants）指令" class="headerlink" title="3.2 常量（constants）指令"></a>3.2 常量（constants）指令</h3><p>常量指令，把常量推入操作数栈顶。</p>
<p>常量的来源有3个：</p>
<ul>
<li>隐含在操作码</li>
<li>操作数</li>
<li>运行时常量池</li>
</ul>
<p>下面是这几种常量来源的具体实现。</p>
<h4 id="3-2-1-隐含在操作码的常量"><a href="#3-2-1-隐含在操作码的常量" class="headerlink" title="3.2.1 隐含在操作码的常量"></a>3.2.1 隐含在操作码的常量</h4><p>所谓的隐含在操作码里，实际上指令绑定了常量，在助记符里就能看出来常量值。</p>
<p>比如指令 <code>iconst_3</code>，就是整数常量3；<code>iconst_m1</code> 就是整数常量-1；<code>dconst_1</code> 就是双精度浮点数1。</p>
<p>这种隐含在操作码的指定，有15条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">aconst_null</span><br><span class="line">iconst_m1</span><br><span class="line">iconst_0</span><br><span class="line">iconst_1</span><br><span class="line">iconst_2</span><br><span class="line">iconst_3</span><br><span class="line">iconst_4</span><br><span class="line">iconst_5</span><br><span class="line">lconst_0</span><br><span class="line">lconst_1</span><br><span class="line">fconst_0</span><br><span class="line">fconst_1</span><br><span class="line">fconst_2</span><br><span class="line">dconst_0</span><br><span class="line">dconst_1</span><br></pre></td></tr></table></figure>

<p>指令这些隐藏常量，是因为这些常量比较常用，懒得浪费1个字节去额外存储。</p>
<p><code>aconst_null</code> 指令把 <code>null</code> 引用推入操作数栈顶：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AConstNull</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().pushRef(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>iconst_m1</code> 指令把 <code>int</code> 型 -1 推入操作数栈顶：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IConstM1</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().pushInt(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dconst_0</code> 指令把 <code>double</code> 型 0 推入操作数栈顶：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DConst0</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().pushDouble(<span class="number">0.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其余常量指令代码都差不多，只是值不同，不再列出。</p>
<h4 id="3-2-2-操作数常量"><a href="#3-2-2-操作数常量" class="headerlink" title="3.2.2 操作数常量"></a>3.2.2 操作数常量</h4><p>有2个指令，是把操作数当作常量，放入操作数栈中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bipush</span><br><span class="line">sipush</span><br></pre></td></tr></table></figure>

<p><code>bipush</code> 是从操作数中读取一个 <code>byte</code> 整数，放入操作数栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BIPush</span> <span class="keyword">implements</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注意是8位有符号整数</span></span><br><span class="line">        val = reader.readInt8();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sipush</code> 是从操作数中读取一个 <code>short</code> 整数，放入操作数栈中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SIPush</span> <span class="keyword">implements</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注意是16位有符号整数</span></span><br><span class="line">        val = reader.readInt16();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，<code>bipush</code> 和 <code>sipush</code> 的操作数都是有符号整数。</p>
<h4 id="3-2-3-常量池常量"><a href="#3-2-3-常量池常量" class="headerlink" title="3.2.3 常量池常量"></a>3.2.3 常量池常量</h4><p>还有几条指令，是从常量池中获取常量，放入操作数栈中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">idc</span><br><span class="line">idcw</span><br><span class="line">idc2w</span><br></pre></td></tr></table></figure>

<p><code>idc</code> 的操作数是8位无符号整数，用于获取 <code>int</code>、<code>float</code> 这些类型的常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IDC</span> <span class="keyword">extends</span> <span class="title">Index8Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        OperandStack stack = frame.getOpStack();</span><br><span class="line">        ConstantPool cp = frame.getMethod().getClazz().getConstantPool();</span><br><span class="line">        Constant constant = cp.getConstant(index);</span><br><span class="line">        <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> IntegerConstant) &#123;</span><br><span class="line">            stack.pushInt(((IntegerConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> FloatConstant) &#123;</span><br><span class="line">            stack.pushFloat(((FloatConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Unsupported Type: &quot;</span> + constant);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>idcw</code> 的操作数是16位无符号整数，用于获取 <code>int</code>、<code>float</code> 这些类型的常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IDCW</span> <span class="keyword">extends</span> <span class="title">Index16Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        OperandStack stack = frame.getOpStack();</span><br><span class="line">        ConstantPool cp = frame.getMethod().getClazz().getConstantPool();</span><br><span class="line">        Constant constant = cp.getConstant(index);</span><br><span class="line">        <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> IntegerConstant) &#123;</span><br><span class="line">            stack.pushInt(((IntegerConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> FloatConstant) &#123;</span><br><span class="line">            stack.pushFloat(((FloatConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Unsupported Type: &quot;</span> + constant);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>idc2w</code> 的操作数是16位无符号整数，用于获取 <code>long</code>、<code>double</code> 类型的常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IDC2W</span> <span class="keyword">extends</span> <span class="title">Index16Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        OperandStack stack = frame.getOpStack();</span><br><span class="line">        ConstantPool cp = frame.getMethod().getClazz().getConstantPool();</span><br><span class="line">        Constant constant = cp.getConstant(index);</span><br><span class="line">        <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> LongConstant) &#123;</span><br><span class="line">            stack.pushLong(((LongConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constant <span class="keyword">instanceof</span> DoubleConstant) &#123;</span><br><span class="line">            stack.pushDouble(((DoubleConstant) constant).value());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassFormatError(<span class="string">&quot;Constant: &quot;</span> + constant);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>idc</code>、<code>idcw</code> 的作用差不多，只是操作数的范围不一样。</p>
<p><code>idc2w</code> 是专门用于 <code>long</code>、<code>double</code> 这种双字类型的指令。</p>
<h3 id="3-3-加载（loads）指令"><a href="#3-3-加载（loads）指令" class="headerlink" title="3.3 加载（loads）指令"></a>3.3 加载（loads）指令</h3><p>加载指令，负责从局部变量表获取变量，然后推入操作数栈顶。</p>
<p>加载指令共33条。</p>
<p>按照操作数类型分的话，可以分为6种：</p>
<ul>
<li>aload 系列指令：操作引用类型变量</li>
<li>dload 系列指令：操作 double 类型变量</li>
<li>fload 系列指令：操作 float 变量</li>
<li>iload 系列指令：操作 int 变量</li>
<li>lload 系列指令：操作 long 变量</li>
<li>xaload 系列指令：操作数组变量</li>
</ul>
<p>实际上各个加载指令都差不多，只是操作数的类型不同。</p>
<p>从局部变量表中获取变量，需要指定变量索引，索引的来源有2个：</p>
<ul>
<li>隐含在操作码中</li>
<li>操作数</li>
</ul>
<p>这2种来源和前面的常量指令差不多。</p>
<p>这里给几个例子：</p>
<p><code>iload_1</code> 指令，把局部变量表中的 1 号整型变量，推入操作数栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ILoad1</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().pushInt(frame.getLocalVars().getInt(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dload_2</code> 指令，把局部变量表中的 2 号 <code>double</code> 变量，推入操作数栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DLoad2</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().pushDouble(frame.getLocalVars().getDouble(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>lload</code> 指令，从操作数中获取索引 index，根据索引去局部变量表中加载第 index 号的 <code>long</code> 变量，推入操作数栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LLoad</span> <span class="keyword">extends</span> <span class="title">Index8Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// index 是 Index8Instruction 读取的8位无符号整数</span></span><br><span class="line">        frame.getOpStack().pushLong(frame.getLocalVars().getLong(index));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似的指令还有 <code>iload</code>、<code>fload</code>、<code>dload</code>、<code>aload</code> 等。</p>
<p>需要注意，<code>long</code>、<code>double</code> 类型实际上是会占用局部变量表和操作数栈的2个插槽 Slot 的，之前已经封装好了。</p>
<h3 id="3-4-存储（stores）指令"><a href="#3-4-存储（stores）指令" class="headerlink" title="3.4 存储（stores）指令"></a>3.4 存储（stores）指令</h3><p>存储指令，负责从操作数栈中弹出变量，放入局部变量表中。</p>
<p>存储指令和加载指令是反过来操作的，所以指令都差不多，实现也就是反过来就行。</p>
<p>这里给几个例子：</p>
<p><code>astore_0</code> 指令，从操作数栈中弹出引用变量，放入局部变量表的 0 号位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AStore0</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getLocalVars().setRef(<span class="number">0</span>, frame.getOpStack().popRef());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fstore_2</code> 指令，从操作数栈中弹出 <code>float</code> 变量，放入局部变量表的 2 号位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FStore2</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getLocalVars().setFloat(<span class="number">2</span>, frame.getOpStack().popFloat());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dstore</code> 指令，在操作数中获取索引 index，从操作数栈中弹出 <code>double</code> 变量，放入局部变量表的 index 号位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DStore</span> <span class="keyword">extends</span> <span class="title">Index8Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// index 是 Index8Instruction 读取的8位无符号整数</span></span><br><span class="line">        frame.getLocalVars().setDouble(index, frame.getOpStack().popDouble());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其余指令实现都差不多，基本是和加载指令反过来而已。</p>
<h3 id="3-5-操作数栈（stack）指令"><a href="#3-5-操作数栈（stack）指令" class="headerlink" title="3.5 操作数栈（stack）指令"></a>3.5 操作数栈（stack）指令</h3><p>操作数栈指令，是直接对操作数栈中的数据进行操作。</p>
<p>共9条，包括：</p>
<ul>
<li>弹出指令：pop 系列指令将栈顶变量弹出</li>
<li>复制指令：dup 系列指令复制栈顶变量</li>
<li>交换指令：swap 指令交换栈顶的两个变量</li>
</ul>
<p>操作数栈指令，直接操作的是插槽 Slot，所以并不关系里面数据的类型。</p>
<p>因为只操作 Slot，所以需要给 OperandStack 增加2个操作 Slot 的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperandStack</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pushSlot</span><span class="params">(Slot slot)</span> </span>&#123;</span><br><span class="line">        slots[size].setSlot(slot);</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Slot <span class="title">popSlot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        size--;</span><br><span class="line">        Slot slot = slots[size];</span><br><span class="line">        Slot copySlot = <span class="keyword">new</span> Slot(slot);</span><br><span class="line">        slot.setSlot(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> copySlot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的弹出 Slot 和推入 Slot，实际上并不是直接替换 Slot 对象，而是改变了它里面的值。</p>
<p>这是为了保证 Slot 对象一直存在，用于占位，避免空指针异常。</p>
<h4 id="3-5-1-弹出指令"><a href="#3-5-1-弹出指令" class="headerlink" title="3.5.1 弹出指令"></a>3.5.1 弹出指令</h4><p>弹出指令包括 <code>pop</code> 和 <code>pop2</code>。</p>
<p><code>pop</code> 指令用于弹出 <code>int</code>、<code>float</code> 等占用1个插槽位置的变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pop</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().popSlot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pop2</code> 指令用于弹出 <code>long</code>、<code>double</code> 等占用2个插槽位置的变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pop2</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().popSlot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="3-5-2-复制指令"><a href="#3-5-2-复制指令" class="headerlink" title="3.5.2 复制指令"></a>3.5.2 复制指令</h4><p>复制指令，用于复制操作数栈的变量。</p>
<p><code>dup</code> 指令是复制栈顶的单个变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dup</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Slot slot = frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot);</span><br><span class="line">        frame.getOpStack().pushSlot(slot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dup2</code> 指令是复制栈顶的2个变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dup2</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Slot slot1 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot2 = frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dupx1</code> 指令是复制栈顶的单个变量，但复制变量不是推入栈顶，具体看实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DupX1</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Slot slot1 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot2 = frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dupx2</code> 指令是复制栈顶的单个变量，但复制变量不是推入栈顶，具体看实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DupX2</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Slot slot1 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot2 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot3 = frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot3);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dup2x1</code> 指令是复制栈顶的2个变量，但复制变量不是推入栈顶，具体看实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dup2X1</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Slot slot1 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot2 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot3 = frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot3);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dup2x2</code> 指令是复制栈顶的2个变量，但复制变量不是推入栈顶，具体看实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dup2X2</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Slot slot1 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot2 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot3 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot4 = frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot4);</span><br><span class="line">        frame.getOpStack().pushSlot(slot3);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了 <code>dup</code>、<code>dup2</code>，其他几个指令还是挺麻烦的。</p>
<h4 id="3-5-3-交换指令"><a href="#3-5-3-交换指令" class="headerlink" title="3.5.3 交换指令"></a>3.5.3 交换指令</h4><p>交换指令，负责交换操作数栈的2个变量。</p>
<p>只有1条指令 <code>swap</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swap</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Slot slot1 = frame.getOpStack().popSlot();</span><br><span class="line">        Slot slot2 = frame.getOpStack().popSlot();</span><br><span class="line">        frame.getOpStack().pushSlot(slot1);</span><br><span class="line">        frame.getOpStack().pushSlot(slot2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-6-数学（math）指令"><a href="#3-6-数学（math）指令" class="headerlink" title="3.6 数学（math）指令"></a>3.6 数学（math）指令</h3><p>数学指令，包括算术（加、减、乘、除）、位移、布尔、自增等基本指令。</p>
<p>共 37 条。</p>
<p>数学指令，都是先从操作数栈中弹出变量，执行数学运算后，再把结果推回操作数栈。</p>
<p>这里给几个例子：</p>
<p>算术指令，整数加法指令 <code>idd</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IAdd</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val1 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">int</span> val2 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">int</span> val = val2 + val1;</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>算术指令，<code>double</code> 类型减法指令 <code>dsub</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DSub</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> val1 = frame.getOpStack().popDouble();</span><br><span class="line">        <span class="keyword">double</span> val2 = frame.getOpStack().popDouble();</span><br><span class="line">        <span class="keyword">double</span> val = val2 - val1;</span><br><span class="line">        frame.getOpStack().pushDouble(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>位移指令，<code>int</code> 整型左移指令 <code>ishl</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IShl</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val1 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">int</span> val2 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">int</span> val = val2 &lt;&lt; (val1 &amp; <span class="number">0x1f</span>);</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>位移指令，<code>long</code> 长整型无符号右移指令 <code>lushr</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LUShr</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注意位移操作数是一个int类型的</span></span><br><span class="line">        <span class="keyword">int</span> val1 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">long</span> val2 = frame.getOpStack().popLong();</span><br><span class="line">        <span class="keyword">long</span> val = val2 &gt;&gt;&gt; (val1 &amp; <span class="number">0x3f</span>);</span><br><span class="line">        frame.getOpStack().pushLong(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>布尔指令，<code>int</code> 整型按位或指令 <code>or</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IOr</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val1 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">int</span> val2 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">int</span> val = val2 | val1;</span><br><span class="line">        frame.getOpStack().pushInt(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自增指令 <code>iinc</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IInc</span> <span class="keyword">implements</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 局部变量索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint8 index;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 常量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val = frame.getLocalVars().getInt(index.value());</span><br><span class="line">        val += value;</span><br><span class="line">        frame.getLocalVars().setInt(index.value(), val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        index = reader.readUint8();</span><br><span class="line">        <span class="comment">// 注意这是一个8位的有符号整数</span></span><br><span class="line">        value = reader.readInt8();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数学指令还是比较简单的，不过像自增指令 <code>iinc</code> 就需要特别注意操作数类型。</p>
<h3 id="3-7-转换（conversions）指令"><a href="#3-7-转换（conversions）指令" class="headerlink" title="3.7 转换（conversions）指令"></a>3.7 转换（conversions）指令</h3><p>转换指令，是指对类型进行强制转换，比如 <code>double</code> 转 <code>long</code>，<code>float</code> 转 <code>int</code> 等。</p>
<p>共15条，这里暂时实现基本类型的转换。</p>
<p>引用类型的强制转换，会走 <code>checkcast</code> 指令，这里还没有办法实现。</p>
<p>这里给出几个例子：</p>
<p><code>i2x</code> 系列指令，<code>i2l</code> 是 <code>int</code> 转 <code>long</code> 类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">I2L</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> l = frame.getOpStack().popInt();</span><br><span class="line">        frame.getOpStack().pushLong(l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>l2x</code> 系列指令，<code>l2d</code> 是 <code>long</code> 转 <code>double</code> 类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">L2D</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> l = frame.getOpStack().popLong();</span><br><span class="line">        <span class="keyword">double</span> d = (<span class="keyword">double</span>) l;</span><br><span class="line">        frame.getOpStack().pushDouble(d);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>f2x</code> 系列指令，<code>f2i</code> 是 <code>float</code> 转 <code>int</code> 类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">F2I</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> f = frame.getOpStack().popFloat();</span><br><span class="line">        <span class="keyword">int</span> i = (<span class="keyword">int</span>) f;</span><br><span class="line">        frame.getOpStack().pushInt(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换类型没什么特别的，都比较简单。</p>
<h3 id="3-8-比较（comparisons）指令"><a href="#3-8-比较（comparisons）指令" class="headerlink" title="3.8 比较（comparisons）指令"></a>3.8 比较（comparisons）指令</h3><p>比较指令，是比较变量的值，然后做出指定的操作。</p>
<p>共 19 条。</p>
<p>比较指令可分为2类：</p>
<ul>
<li>比较后，结果推入操作数栈顶</li>
<li>比较后，根据结果跳转</li>
</ul>
<p>比较指令主要用于实现 <code>if-else</code>、<code>for</code>、<code>while</code> 等语句。</p>
<h4 id="3-8-1-结果推入操作数栈"><a href="#3-8-1-结果推入操作数栈" class="headerlink" title="3.8.1 结果推入操作数栈"></a>3.8.1 结果推入操作数栈</h4><p>比较返回结果的指令有5条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lcmp</span><br><span class="line">fcmpg</span><br><span class="line">fcmpl</span><br><span class="line">dcmpg</span><br><span class="line">dcmpl</span><br></pre></td></tr></table></figure>

<p><code>lcmp</code> 指令用于比较 <code>long</code> 变量，并将结果（<code>int</code> 类型的-1/0/1）推入操作数栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LCmp</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> v2 = frame.getOpStack().popLong();</span><br><span class="line">        <span class="keyword">long</span> v1 = frame.getOpStack().popLong();</span><br><span class="line">        <span class="keyword">int</span> v = CmpUtil.cmpLong(v1, v2);</span><br><span class="line">        frame.getOpStack().pushInt(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于浮点数计算有可能产生 <code>NaN</code>（Not a Number）值，所以比较两个浮点数时，除了大于、等于、小于之外，还有第4种结果：无法比较。</p>
<p><code>fcmpg</code> 和 <code>fcmpl</code> 指令都是用于比较 float 变量，意义都差不多。</p>
<p><code>fcmpg</code> 和 <code>fcmpl</code> 指令的区别就在于对第4种结果（无法比较）的定义。</p>
<p>两个 · 变量中至少有一个是 <code>NaN</code> 时，用 <code>fcmpg</code> 指令比较的结果是1，而用 <code>fcmpl</code> 指令比较的结果是-1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FCmpg</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> v2 = frame.getOpStack().popFloat();</span><br><span class="line">        <span class="keyword">float</span> v1 = frame.getOpStack().popFloat();</span><br><span class="line">        <span class="keyword">int</span> v = CmpUtil.cmpFloat(v1, v2, <span class="keyword">true</span>);</span><br><span class="line">        frame.getOpStack().pushInt(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FCmpl</span> <span class="keyword">extends</span> <span class="title">NoOperandsInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> v2 = frame.getOpStack().popFloat();</span><br><span class="line">        <span class="keyword">float</span> v1 = frame.getOpStack().popFloat();</span><br><span class="line">        <span class="keyword">int</span> v = CmpUtil.cmpFloat(v1, v2, <span class="keyword">false</span>);</span><br><span class="line">        frame.getOpStack().pushInt(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面几个命令有用到的工具类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CmpUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cmpLong</span><span class="params">(<span class="keyword">long</span> v1, <span class="keyword">long</span> v2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Long.compare(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cmpFloat</span><span class="params">(<span class="keyword">float</span> v1, <span class="keyword">float</span> v2, <span class="keyword">boolean</span> gFlag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v1 &gt; v2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v1 == v2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v1 &lt; v2) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gFlag) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dcmpg</code> 和 <code>dcmpl</code> 指令用来比较 <code>double</code> 变量，它们的意义和 <code>fcmpg</code>、<code>fcmpl</code> 指令一样，这里不再给出。</p>
<h4 id="3-8-2-比较跳转"><a href="#3-8-2-比较跳转" class="headerlink" title="3.8.2 比较跳转"></a>3.8.2 比较跳转</h4><p>比较跳转的指令有14条，可以分为2类：</p>
<ul>
<li>单操作数指令：<code>if&lt;cond&gt;</code> 指令</li>
<li>双操作数指令：<code>if_icmp&lt;cond&gt;</code> 和 <code>if_acmp&lt;cond&gt;</code> 指令</li>
</ul>
<p>单操作数 <code>if&lt;cond&gt;</code> 指令，是从栈顶弹出一个 <code>int</code> 整型变量和 0 进行比较：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ifeq: x == 0</span><br><span class="line">ifne: x != 0</span><br><span class="line">iflt: x &lt; 0</span><br><span class="line">ifle: x &lt;= 0</span><br><span class="line">ifgt: x &gt; 0</span><br><span class="line">ifge: x &gt;= 0</span><br></pre></td></tr></table></figure>

<p>实现很简单，<code>ifeq</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfEq</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> v1 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (v1 == <span class="number">0</span>) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ifle</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfLe</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> v1 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (v1 &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他指令类似，不在举例。</p>
<p>双操作数指令 <code>if_icmp&lt;cond&gt;</code>，用于从栈顶弹出2个 <code>int</code> 整型变量进行比较，然后跳转：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if_icmpeq: if x1 == x2</span><br><span class="line">if_icmpne: if x1 != x2</span><br><span class="line">if_icmplt: if x1 &lt; x2</span><br><span class="line">if_icmple: if x1 &lt;= x2</span><br><span class="line">if_icmpgt: if x1 &gt; x2</span><br><span class="line">if_icmpge: if x1 &gt;= x2</span><br></pre></td></tr></table></figure>

<p><code>if_icmpne</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfICmpNe</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> v2 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">int</span> v1 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (v1 != v2) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>if_icmpgt</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfICmpGt</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> v2 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">int</span> v1 = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (v1 &gt; v2) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>双操作数指令 <code>if_acmp&lt;cond&gt;</code>，也是从栈顶弹出2个变量，不过是引用变量，引用变量的比较只有2种情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if_acmpeq: if x1 == x2</span><br><span class="line">if_acmpne: if x1 != x2</span><br></pre></td></tr></table></figure>

<p><code>if_acmpeq</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfACmpEq</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Object v2 = frame.getOpStack().popRef();</span><br><span class="line">        Object v1 = frame.getOpStack().popRef();</span><br><span class="line">        <span class="keyword">if</span> (v1 == v2) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>if_acmpne</code> 指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfACmpNe</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Object v2 = frame.getOpStack().popRef();</span><br><span class="line">        Object v1 = frame.getOpStack().popRef();</span><br><span class="line">        <span class="keyword">if</span> (v1 != v2) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-9-控制（control）指令"><a href="#3-9-控制（control）指令" class="headerlink" title="3.9 控制（control）指令"></a>3.9 控制（control）指令</h3><p>控制指令，主要用于地址的直接跳转。</p>
<p>比如 <code>return</code>、<code>goto</code>、<code>switch</code> 等语句的实现。</p>
<p>包括的指令有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">goto</span><br><span class="line">tableswitch</span><br><span class="line">lookupswitch</span><br><span class="line">ireturn</span><br><span class="line">lreturn</span><br><span class="line">freturn</span><br><span class="line">dreturn</span><br><span class="line">areturn</span><br></pre></td></tr></table></figure>

<p><code>return</code> 系列指令等后面再实现。</p>
<p><code>goto</code> 指令进行无条件跳转：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Goto</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        branch(frame);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tableswitch</code> 指令和 <code>lookupswitch</code> 指令都是用于实现 <code>switch</code> 语句的：</p>
<ul>
<li><code>tableswitch</code> 指令：<code>case</code> 值可以编码成一个索引表</li>
<li><code>lookupswitch</code> 指令：<code>case</code> 值不可以编码成一个索引表</li>
</ul>
<p>什么时候 <code>case</code> 值可以编码成一个索引表？比如下面这2个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (i) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:  <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:  <span class="keyword">return</span>  <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:  <span class="keyword">return</span>  <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种 <code>case</code> 值是大于等于 0 的值，可以作为索引，就会编译成 <code>tableswitch</code> 指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (i) &#123;</span><br><span class="line">    <span class="keyword">case</span> -<span class="number">100</span>: <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:    <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:  <span class="keyword">return</span>  <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">default</span>:   <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种存在负数的值，就不能用作索引，就会编译成 <code>lookupswitch</code> 指令。</p>
<p><code>tableswitch</code> 指令的实现是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableSwitch</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> defaultOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> low;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> high;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] jumpOffsets;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = frame.getOpStack().popInt();</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= low &amp;&amp; index &lt;= high) &#123;</span><br><span class="line">            offset = jumpOffsets[index - low];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            offset = defaultOffset;</span><br><span class="line">        &#125;</span><br><span class="line">        branch(frame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        reader.skipPadding();</span><br><span class="line">        defaultOffset = reader.readInt();</span><br><span class="line">        low = reader.readInt();</span><br><span class="line">        high = reader.readInt();</span><br><span class="line">        <span class="keyword">int</span> jumpOffsetsCount = high - low + <span class="number">1</span>;</span><br><span class="line">        jumpOffsets = reader.readInts(jumpOffsetsCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>defaultOffset</code> 就是 <code>switch</code> 语句中的 <code>default</code> 语句，而 <code>low</code> 和 <code>high</code> 则是对应的 <code>case</code> 语句的范围。</p>
<p><code>jumpOffsets</code> 是一个索引表，里面存放 <code>high - low + 1</code> 个 <code>int</code> 值，对应各种 <code>case</code> 情况下，执行跳转所需的字节码偏移量。</p>
<p><code>tableswitch</code> 指令的操作数是从栈中弹出的，作为偏移量地址，如果在 <code>low</code> 和 <code>high</code> 范围内，则说明是 <code>case</code> 语句，否则是 <code>default</code> 语句。</p>
<p><code>tableswitch</code> 指令操作码的后面有 0~3 字节的 <code>padding</code>，这个是为了对齐地址用的，保证 <code>defaultOffset</code> 在字节码中的地址是4的倍数。</p>
<p>下面是 <code>lookupswitch</code> 指令的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupSwitch</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> defaultOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> npairs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] matchOffsets;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> key = frame.getOpStack().popInt();</span><br><span class="line">        offset = defaultOffset;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; npairs * <span class="number">2</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matchOffsets[i] == key) &#123;</span><br><span class="line">                offset = matchOffsets[i + <span class="number">1</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        branch(frame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        reader.skipPadding();</span><br><span class="line">        defaultOffset = reader.readInt();</span><br><span class="line">        npairs = reader.readInt();</span><br><span class="line">        matchOffsets = reader.readInts(npairs * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>defaultOffset</code> 也是默认的地址偏移量，<code>npairs</code> 表示有多少个 <code>case</code> 语句。</p>
<p>每个 <code>case</code> 语句都包括2部分内容：一个就是 <code>case</code> 的 key 值，比如前面的 100，一个是 <code>case</code> 代码的地址偏移量，表示跳转的偏移地址。</p>
<p><code>lookupswitch</code> 指令的操作数也是从栈中弹出，作为 <code>case</code> 的 <code>key</code> 去比较，找到则跳转到 <code>case</code> 对应的偏移地址，否则跳到 <code>default</code> 语句。</p>
<p><code>lookupswitch</code> 指令也有地址对齐的操作，和 <code>tableswitch</code> 指令作用一样。</p>
<h3 id="3-10-引用（references）指令"><a href="#3-10-引用（references）指令" class="headerlink" title="3.10 引用（references）指令"></a>3.10 引用（references）指令</h3><p>引用指令，是和字段访问、方法调用相关的指令。</p>
<p>这里暂不实现。</p>
<h3 id="3-11-扩展（extended）指令"><a href="#3-11-扩展（extended）指令" class="headerlink" title="3.11 扩展（extended）指令"></a>3.11 扩展（extended）指令</h3><p>扩展指令，是给一些操作数比较小的指令进行扩展。</p>
<p>扩展指令有3类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wide</span><br><span class="line">ifnull 和 ifnonnull</span><br><span class="line">goto_w</span><br></pre></td></tr></table></figure>

<h4 id="3-11-1-wide"><a href="#3-11-1-wide" class="headerlink" title="3.11.1 wide"></a>3.11.1 wide</h4><p><code>wide</code> 指令用于扩展操作索引的范围。</p>
<p>比如加载指令、存储指令等需要访问局部变量表的指令，索引用的都是 uint8 字节。</p>
<p>对于大部分方法来说，uint8 的大小已经足够满足了，但是不排除有些方法的局部变量表过大，所以才使用 <code>wide</code> 执行来扩展它们。</p>
<p>扩展的指令包括：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0x15: iload</span><br><span class="line">0x16: lload</span><br><span class="line">0x17: fload</span><br><span class="line">0x18: dload</span><br><span class="line">0x19: aload</span><br><span class="line">0x36: istore</span><br><span class="line">0x37: lstore</span><br><span class="line">0x38: fstore</span><br><span class="line">0x39: dstore</span><br><span class="line">0x3a: astore</span><br><span class="line">0x84: iinc</span><br><span class="line">0xa9: ret</span><br></pre></td></tr></table></figure>

<p><code>wide</code> 指令只是增加了索引宽度，并不改变子指令操作。</p>
<p>比如，原来的加载指令 <code>iload</code> 操作数是一个 uint8 字节的索引，在 <code>wide</code> 指令中则是 uint16 的双字节索引：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WILoad</span> <span class="keyword">extends</span> <span class="title">Index16Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getOpStack().pushInt(frame.getLocalVars().getInt(index));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这里换成了 <code>Index16Instruction</code> 基类，使用的是2字节的索引。</p>
<p>同理，<code>dstore</code> 指令也换成了双操作数索引：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WDStore</span> <span class="keyword">extends</span> <span class="title">Index16Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        frame.getLocalVars().setDouble(index, frame.getOpStack().popDouble());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自增指令 <code>iinc</code> 也是一样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WIInc</span> <span class="keyword">implements</span> <span class="title">Instruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 局部变量索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Uint16 index;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 常量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val = frame.getLocalVars().getInt(index.value());</span><br><span class="line">        val += value;</span><br><span class="line">        frame.getLocalVars().setInt(index.value(), val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        index = reader.readUint16();</span><br><span class="line">        <span class="comment">// 注意这里是16位有符号整数</span></span><br><span class="line">        value = reader.readInt16();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他指令类似，不再列出。</p>
<h4 id="3-11-2-ifnull-和-ifnonnul"><a href="#3-11-2-ifnull-和-ifnonnul" class="headerlink" title="3.11.2 ifnull 和 ifnonnul"></a>3.11.2 ifnull 和 ifnonnul</h4><p>和前面的比较指令差不多，<code>ifnull</code> 和 <code>ifnonnull</code> 就是用于比较 <code>null</code> 值并跳转的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfNull</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Object v1 = frame.getOpStack().popRef();</span><br><span class="line">        <span class="keyword">if</span> (v1 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfNonNull</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        Object v1 = frame.getOpStack().popRef();</span><br><span class="line">        <span class="keyword">if</span> (v1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            branch(frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-11-3-goto-w"><a href="#3-11-3-goto-w" class="headerlink" title="3.11.3 goto_w"></a>3.11.3 goto_w</h4><p>前面的 <code>goto</code> 指令操作数是 int16 位有符号整数，<code>goto_w</code> 指令则是扩展成 int32 位有符号整数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WGoto</span> <span class="keyword">extends</span> <span class="title">BranchInstruction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Frame frame)</span> </span>&#123;</span><br><span class="line">        branch(frame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fetchOperands</span><span class="params">(ByteCodeReader reader)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注意是32位有符号整数</span></span><br><span class="line">        offset = reader.readInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-12-保留（reserved）指令"><a href="#3-12-保留（reserved）指令" class="headerlink" title="3.12 保留（reserved）指令"></a>3.12 保留（reserved）指令</h3><p>保留指令是留给虚拟机用的，这里暂时不实现。</p>
<h2 id="四、解释器"><a href="#四、解释器" class="headerlink" title="四、解释器"></a>四、解释器</h2><p>完成所有指令的解析之后，就可以实现一个简单的解释器，执行解析好的指令。</p>
<p>因为方法的调用，最后都会执行 <code>return</code> 语句，由于暂时未实现 <code>return</code> 语句，所以解释器目前只能执行一个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Interpreter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interpret</span><span class="params">(MethodInfo methodInfo)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 拿到方法的代码属性</span></span><br><span class="line">        CodeAttributeInfo codeAttr = methodInfo.getCodeAttributeInfo();</span><br><span class="line">        Uint16 maxLocals = codeAttr.getMaxLocals();</span><br><span class="line">        Uint16 maxStack = codeAttr.getMaxStack();</span><br><span class="line">        <span class="keyword">byte</span>[] codes = codeAttr.getCodes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个栈帧测试</span></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread();</span><br><span class="line">        Frame frame = thread.newFrame(maxLocals.value(), maxStack.value());</span><br><span class="line">        thread.pushFrame(frame);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解释执行代码</span></span><br><span class="line">        loop(thread, codes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">(Thread thread, <span class="keyword">byte</span>[] codes)</span> </span>&#123;</span><br><span class="line">        Frame frame = thread.popFrame();</span><br><span class="line">        ByteCodeReader reader = <span class="keyword">new</span> ByteCodeReader(codes);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 程序计数器地址</span></span><br><span class="line">                <span class="keyword">int</span> pc = frame.getNextPc();</span><br><span class="line">                thread.setPc(pc);</span><br><span class="line">                reader.setPosition(pc);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 编译识别指令</span></span><br><span class="line">                <span class="keyword">int</span> opcode = reader.readUint8().value();</span><br><span class="line">                Instruction instruction = InstructionFactory.newInstance(opcode);</span><br><span class="line">                <span class="keyword">if</span> (instruction == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取指定操作数</span></span><br><span class="line">                instruction.fetchOperands(reader);</span><br><span class="line">                frame.setNextPc(reader.getPosition());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 执行指令</span></span><br><span class="line">                instruction.execute(frame);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Frame: &quot;</span> + frame);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释器的逻辑很简单：</p>
<ol>
<li>从指定方法中拿出 <code>code</code> 代码属性</li>
<li>根据指令集解析 <code>code</code> 代码的指令</li>
<li>执行解析好的指令</li>
</ol>
<p>由于没有实现 <code>return</code> 指令，所以不能很好的看出结果，而且执行到最后肯定会报错。</p>
<p>这里通过捕获错误，并打印栈帧来查看结果。</p>
<p><code>getCodeAttributeInfo()</code>、<code>getMaxLocals()</code> 这些都是 <code>MethodInfo</code> 新增的 <code>get</code> 方法，这里不多说。</p>
<p><code>InstructionFactory.newInstance(opcode)</code> 是根据字节码生成对应的指令，实现差不多这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstructionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Instruction <span class="title">newInstance</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x00</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Nop();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x01</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> AConstNull();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x02</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> IConstM1();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x03</span>:</span><br><span class="line">                .</span><br><span class="line">                .</span><br><span class="line">                .</span><br><span class="line">               ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>太长了，这里就不全列举出来了。</p>
<p>还需要改造一下 Jvm 类的代码，让他可以跑指定的方法，这里执行的是 main 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jvm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Cmd cmd = <span class="keyword">new</span> Cmd();</span><br><span class="line">        cmd.printHelp();</span><br><span class="line"></span><br><span class="line">        String[] testArgs = <span class="keyword">new</span> String[]&#123; <span class="string">&quot;com.wjd.cmd.Cmd&quot;</span>, <span class="string">&quot;-classpath&quot;</span>,</span><br><span class="line">                <span class="string">&quot;D:\\Projects\\IdeaProjects\\self-jvm\\target\\test-classes;D:\\Projects\\IdeaProjects\\self-jvm\\target\\classes&quot;</span> &#125;;</span><br><span class="line">        cmd.parse(testArgs);</span><br><span class="line"></span><br><span class="line">        String userClassName = <span class="string">&quot;com\\wjd\\instructions\\InstructionsTest&quot;</span>;</span><br><span class="line">        Classpath classpath = <span class="keyword">new</span> Classpath(cmd.getJreOption(), cmd.getCpOption());</span><br><span class="line"></span><br><span class="line">        ClassFile classFile = loadClass(userClassName, classpath);</span><br><span class="line">        MethodInfo mainMethod = getMainMethod(classFile);</span><br><span class="line">        <span class="keyword">if</span> (mainMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 解释器执行，解释执行 main 方法</span></span><br><span class="line">            <span class="keyword">new</span> Interpreter().interpret(mainMethod);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Not found main method!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassFile <span class="title">loadClass</span><span class="params">(String className, Classpath classpath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] userClassBytes = classpath.readClass(className);</span><br><span class="line">        ClassReader reader = <span class="keyword">new</span> ClassReader(userClassBytes);</span><br><span class="line">        <span class="keyword">return</span> ClassFile.parse(reader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取类文件中的main方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MethodInfo <span class="title">getMainMethod</span><span class="params">(ClassFile classFile)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (MethodInfo m : classFile.getMethods())</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;main&quot;</span>.equals(m.name()) &amp;&amp; <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>.equals(m.descriptor())) &#123;</span><br><span class="line">                <span class="keyword">return</span> m;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改的内容就是找到测试类，拿出它的 main 方法，然后交给解释器 <code>Interpreter</code> 去解释执行。</p>
<h2 id="五、单元测试"><a href="#五、单元测试" class="headerlink" title="五、单元测试"></a>五、单元测试</h2><p>测试类，就是要测试执行它的 main 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstructionsTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            sum += i;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试应该会出现错误，在异常捕获里面，栈帧输出结果里面应该包含结果值 <code>5050</code>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="指令结构"><a href="#指令结构" class="headerlink" title="指令结构"></a>指令结构</h3><ul>
<li>字节码中存放编码后的 Java 虚拟机指令，每条指令都以一个单字节的操作码（opcode）开头</li>
<li>由于只使用一字节表示操作码，Java 虚拟机最多只能支持 256 条指令</li>
<li>Java 虚拟机使用的是变长指令，操作码后面可以跟零字节或多字节的操作数（operand）</li>
<li>比如 <code>0xB20002</code> 这条指令，<code>B2</code> 表示该指令的操作码，<code>0002</code> 就表示操作数</li>
</ul>
<h3 id="指令助记符"><a href="#指令助记符" class="headerlink" title="指令助记符"></a>指令助记符</h3><ul>
<li>为了便于记忆，Java 虚拟机规范给每个操作码都指定了一个助记符（mnemonic）</li>
<li>比如，操作码是 <code>0x00</code> 的助记符是 nop（no operation）</li>
<li>操作数栈和局部变量表只存放数据的值（Slot），并不记录数据类型</li>
<li>指令必须知道自己在操作什么类型的数据，即指令绑定了数据类型</li>
<li>例如，<code>iadd</code> 指令就是对 <code>int</code> 值进行加法操作</li>
</ul>
<h3 id="指令类型"><a href="#指令类型" class="headerlink" title="指令类型"></a>指令类型</h3><p>Java 虚拟机规范把已经定义的205条指令按用途分成了11类，分别是：</p>
<ul>
<li>常量（constants）指令</li>
<li>加载（loads）指令</li>
<li>存储（stores）指令</li>
<li>操作数栈（stack）指令</li>
<li>数学（math）指令</li>
<li>转换（conversions）指令</li>
<li>比较（comparisons）指令</li>
<li>控制（control）指令</li>
<li>引用（references）指令</li>
<li>扩展（extended）指令</li>
<li>保留（reserved）指令</li>
</ul>
<p>保留指令：</p>
<ul>
<li>1条是留给调试器的，用于实现断点，操作码是 <code>202(0xCA)</code>，助记符是 <code>breakpoint</code></li>
<li>另外2条留给 Java 虚拟机实现内部使用，操作码分别是 <code>254(0xFE)</code> 和 <code>266(0xFF)</code>，助记符是 <code>impdep1</code> 和 <code>impdep2</code></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/JVM/" rel="tag"># JVM</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/design_pattern/mediator/" rel="prev" title="中介者模式">
      <i class="fa fa-chevron-left"></i> 中介者模式
    </a></div>
      <div class="post-nav-item">
    <a href="/lang/java/core/concurrency/02_%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7/" rel="next" title="02_线程安全性">
      02_线程安全性 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E9%9B%86%E5%92%8C%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="nav-text">指令集和解释器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4"><span class="nav-text">一、字节码指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%8C%87%E4%BB%A4%E7%BB%93%E6%9E%84"><span class="nav-text">1.1 指令结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%8C%87%E4%BB%A4%E5%8A%A9%E8%AE%B0%E7%AC%A6"><span class="nav-text">1.2 指令助记符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E6%8C%87%E4%BB%A4%E7%B1%BB%E5%9E%8B"><span class="nav-text">1.3 指令类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%8C%87%E4%BB%A4%E8%BF%90%E8%A1%8C"><span class="nav-text">二、指令运行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%8C%87%E4%BB%A4%E5%BE%AA%E7%8E%AF"><span class="nav-text">2.1 指令循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E6%8C%87%E4%BB%A4%E6%8E%A5%E5%8F%A3"><span class="nav-text">2.2 指令接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E6%8C%87%E4%BB%A4%E8%A7%A3%E7%A0%81"><span class="nav-text">2.2 指令解码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="nav-text">三、指令集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E6%8A%BD%E8%B1%A1%E6%8C%87%E4%BB%A4%E5%9F%BA%E7%B1%BB"><span class="nav-text">3.1 抽象指令基类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%B8%B8%E9%87%8F%EF%BC%88constants%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.2 常量（constants）指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-%E9%9A%90%E5%90%AB%E5%9C%A8%E6%93%8D%E4%BD%9C%E7%A0%81%E7%9A%84%E5%B8%B8%E9%87%8F"><span class="nav-text">3.2.1 隐含在操作码的常量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-%E6%93%8D%E4%BD%9C%E6%95%B0%E5%B8%B8%E9%87%8F"><span class="nav-text">3.2.2 操作数常量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-%E5%B8%B8%E9%87%8F%E6%B1%A0%E5%B8%B8%E9%87%8F"><span class="nav-text">3.2.3 常量池常量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%8A%A0%E8%BD%BD%EF%BC%88loads%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.3 加载（loads）指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E5%AD%98%E5%82%A8%EF%BC%88stores%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.4 存储（stores）指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88%EF%BC%88stack%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.5 操作数栈（stack）指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-1-%E5%BC%B9%E5%87%BA%E6%8C%87%E4%BB%A4"><span class="nav-text">3.5.1 弹出指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-2-%E5%A4%8D%E5%88%B6%E6%8C%87%E4%BB%A4"><span class="nav-text">3.5.2 复制指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-3-%E4%BA%A4%E6%8D%A2%E6%8C%87%E4%BB%A4"><span class="nav-text">3.5.3 交换指令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-%E6%95%B0%E5%AD%A6%EF%BC%88math%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.6 数学（math）指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-%E8%BD%AC%E6%8D%A2%EF%BC%88conversions%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.7 转换（conversions）指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-%E6%AF%94%E8%BE%83%EF%BC%88comparisons%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.8 比较（comparisons）指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-8-1-%E7%BB%93%E6%9E%9C%E6%8E%A8%E5%85%A5%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88"><span class="nav-text">3.8.1 结果推入操作数栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-8-2-%E6%AF%94%E8%BE%83%E8%B7%B3%E8%BD%AC"><span class="nav-text">3.8.2 比较跳转</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-%E6%8E%A7%E5%88%B6%EF%BC%88control%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.9 控制（control）指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-10-%E5%BC%95%E7%94%A8%EF%BC%88references%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.10 引用（references）指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-11-%E6%89%A9%E5%B1%95%EF%BC%88extended%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.11 扩展（extended）指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-11-1-wide"><span class="nav-text">3.11.1 wide</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-11-2-ifnull-%E5%92%8C-ifnonnul"><span class="nav-text">3.11.2 ifnull 和 ifnonnul</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-11-3-goto-w"><span class="nav-text">3.11.3 goto_w</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-12-%E4%BF%9D%E7%95%99%EF%BC%88reserved%EF%BC%89%E6%8C%87%E4%BB%A4"><span class="nav-text">3.12 保留（reserved）指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="nav-text">四、解释器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-text">五、单元测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E7%BB%93%E6%9E%84"><span class="nav-text">指令结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E5%8A%A9%E8%AE%B0%E7%AC%A6"><span class="nav-text">指令助记符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E7%B1%BB%E5%9E%8B"><span class="nav-text">指令类型</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="jiaduo"
      src="/images/lufei.jpeg">
  <p class="site-author-name" itemprop="name">jiaduo</p>
  <div class="site-description" itemprop="description">不积跬步，无以至千里</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">109</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

      
      
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021/08 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jiaduo</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">408k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:11</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
